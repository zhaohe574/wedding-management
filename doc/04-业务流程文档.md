# 婚庆管家 - 业务流程文档

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v1.0.0  
**创建日期**: 2025-12-31

---

## 一、系统角色定义

### 1.1 角色列表

| 角色 | 说明 | 使用端 |
|-----|------|-------|
| 用户（会员） | 预约服务的客户 | 小程序（统一应用） |
| 服务提供者 | 提供服务的人员（主持人/跟拍/管家） | 小程序（统一应用，角色判断） |
| 管理员 | 系统管理人员 | PC管理端 |

**说明**: 小程序端为统一应用，通过用户角色（`role`字段）判断显示不同功能模块。

### 1.2 角色权限

**用户权限**:
- 浏览服务提供者列表和详情（支持多服务类型筛选）
- 查看服务提供者档期
- 添加服务到购物车（支持多选不同服务类型、场次、套餐）
- 管理购物车（编辑、删除、批量结算）
- 创建预约订单（支持所有服务类型，支持购物车批量结算）
- 查看和管理自己的订单（支持按服务类型筛选）
- 取消订单、申请退款
- 发表评价
- 浏览动态、点赞、评论
- 收藏服务提供者

**服务提供者权限**:
- 查看工作台统计数据
- 查看和审核订单（同意/拒绝）
- 确认服务完成
- 管理个人档期
- 发布和管理动态
- 回复评价
- 管理个人资料
- **注意**: 服务提供者**不能**自己设置标签，标签只能由管理员设置

**管理员权限**:
- 管理服务提供者（增删改查，支持所有服务类型）
  - **设置服务提供者标签**（仅管理员可操作，服务提供者不能自己设置）
- 管理服务类型配置
- 管理服务提供者标签（支持按服务类型，仅管理员可创建和管理）
- 查看所有订单（支持按服务类型筛选）
- 确认付款（上传付款凭证）
- 处理退款（上传退款凭证）
- 审核评价和动态
- 系统配置管理
- 查看统计报表（支持按服务类型统计）
- DIY页面装修（拖拉拽模式）

---

## 二、核心业务流程

### 2.1 用户注册/登录流程

```
┌──────────────────────────────────────────────────────────────┐
│                      用户注册/登录流程                         │
└──────────────────────────────────────────────────────────────┘

用户打开小程序
    │
    ▼
┌─────────────┐     否      ┌─────────────┐
│  检查Token  │───────────→│  触发登录   │
│  是否有效   │             │             │
└──────┬──────┘             └──────┬──────┘
       │ 是                        │
       ▼                           ▼
┌─────────────┐             ┌─────────────┐
│  直接进入   │             │ 微信授权    │
│  小程序     │             │ 获取code    │
└─────────────┘             └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │ 调用登录接口 │
                            │ /auth/login │
                            └──────┬──────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ▼                             ▼
             ┌─────────────┐              ┌─────────────┐
             │  新用户     │              │  老用户     │
             │  自动注册   │              │  直接登录   │
             └──────┬──────┘              └──────┬──────┘
                    │                             │
                    └──────────────┬──────────────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │ 返回Token   │
                            │ 和用户信息   │
                            └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │ 本地存储    │
                            │ Token       │
                            └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                            │  进入首页   │
                            └─────────────┘
```

### 2.2 预约下单流程（核心）

**说明**: 流程中展示的选项均来源于系统配置，流程本身不依赖固定业务规则。

```
┌──────────────────────────────────────────────────────────────┐
│                        预约下单流程                           │
└──────────────────────────────────────────────────────────────┘

用户浏览服务提供者列表
    │
    ▼
选择服务提供者查看详情
    │
    ▼
查看档期日历
    │
    ├─── 无空闲档期 ───→ 选择其他日期或服务提供者
    │
    ▼ 有空闲档期
选择系统支持的服务时间段（基于服务类型配置）
    │
    ▼
选择服务套餐
    │
    ├─── 可选：选择增值服务
    │
    ▼
填写联系信息
    │
    ├─── 联系人姓名（必填）
    ├─── 联系电话（必填）
    ├─── 婚礼场地（选填）
    └─── 备注（选填）
    │
    ▼
确认订单信息
    │
    ▼
提交订单 ───────────────────────────────────────┐
    │                                           │
    ▼                                           │
┌─────────────────────────────┐                 │
│ 系统处理：                   │                 │
│ 1. 验证档期可用性            │                 │
│ 2. 计算订单金额              │                 │
│ 3. 创建订单记录              │                 │
│ 4. 锁定档期                  │                 │
│ 5. 记录状态日志              │                 │
└──────────────┬──────────────┘                 │
               │                                │
               ▼                                │
        订单状态：待审核(0)                       │
               │                                │
               ▼                                │
┌─────────────────────────────┐                 │
│ 通知主持人：                 │                 │
│ 新订单待审核                 │◀───────────────┘
└──────────────┬──────────────┘
               │
               ▼
        等待主持人审核
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐ ┌─────────────┐
│ 主持人同意  │ │ 主持人拒绝  │
└──────┬──────┘ └──────┬──────┘
       │               │
       ▼               ▼
订单状态：已同意(1)  订单状态：已拒绝(-1)
       │               │
       ▼               ▼
通知用户：已同意    通知用户：已拒绝
等待付款            显示拒绝原因
       │               │
       ▼               │
等待管理员确认付款      │
       │               │
       ▼               │
管理员上传付款凭证      │
       │               │
       ▼               │
订单状态：已付款(2)     │
       │               │
       ▼               │
通知用户和主持人        │
       │               │
       ▼               │
订单状态：待服务(3)     │
       │               │
       ▼               │
【服务日当天】          │
       │               │
       ▼               │
主持人确认服务完成      │
       │               │
       ▼               │
订单状态：已完成(4)     │
       │               │
       ▼               ▼
通知用户评价         流程结束
       │
       ▼
   流程结束
```

### 2.3 订单状态流转图（含状态定义）

**状态定义表（拆状态设计）**:

**业务主状态（order_status）** - 订单生命周期：
| 状态值 | 状态名称 | 数据库字段 | 可持久化 | 进入条件 | 离开条件 | 是否终态 |
|-------|---------|-----------|---------|---------|---------|---------|
| 0 | 待审核(CREATED) | order_status | ✅ | 用户提交订单成功 | 服务提供者同意/拒绝，或用户取消，或管理员关闭 | ❌ |
| 1 | 已同意(CONFIRMED) | order_status | ✅ | 服务提供者同意订单 | 管理员确认付款后自动流转为待服务，或用户取消，或管理员关闭 | ❌ |
| 3 | 待服务(SERVING) | order_status | ✅ | 订单已付款自动流转 | 服务提供者确认完成，或用户申请退款，或管理员关闭 | ❌ |
| 4 | 已完成(FINISHED) | order_status | ✅ | 服务提供者确认服务完成 | 无（终态） | ✅ |
| 10 | 已拒绝(REJECTED) | order_status | ✅ | 服务提供者拒绝订单 | 无（终态） | ✅ |
| 11 | 已取消(CANCELLED) | order_status | ✅ | 用户取消订单 | 无（终态） | ✅ |
| 13 | 已关闭(CLOSED) | order_status | ✅ | 管理员强制关闭订单 | 无（终态） | ✅ |

**支付状态（payment_status）** - 财务状态：
| 状态值 | 状态名称 | 数据库字段 | 进入条件 | 离开条件 |
|-------|---------|-----------|---------|---------|
| 0 | 未付款(UNPAID) | payment_status | 订单创建时默认 | 管理员确认付款 |
| 1 | 已付款(PAID) | payment_status | 管理员确认付款 | 退款完成后 |
| 2 | 部分退款(PARTIAL_REFUND) | payment_status | 部分退款完成 | - |
| 3 | 已退款(FULL_REFUND) | payment_status | 全额退款完成 | - |

**退款状态（refund_status）** - 退款流程：
| 状态值 | 状态名称 | 数据库字段 | 进入条件 | 离开条件 |
|-------|---------|-----------|---------|---------|
| 0 | 无退款(NONE) | refund_status | 订单创建时默认 | 用户申请退款 |
| 1 | 退款申请中(APPLY) | refund_status | 用户申请退款 | 管理员审核 |
| 2 | 退款已同意(APPROVED) | refund_status | 管理员同意退款 | 退款完成 |
| 3 | 退款已拒绝(REJECTED) | refund_status | 管理员拒绝退款 | - |
| 4 | 退款已完成(COMPLETED) | refund_status | 退款完成 | - |

**状态组合说明**：
- 订单完整状态由 `order_status` + `payment_status` + `refund_status` 共同决定
- 详细状态组合规则见《00-系统设计总纲.md》状态机定义章节

**异常流程处理**:
- **档期冲突**: 用户提交订单时，如果档期已被占用，返回错误码3001，提示选择其他日期或场次
- **重复提交**: 通过 `client_request_id` 幂等键防止重复创建订单，相同请求ID返回已存在的订单
- **并发审核**: 使用数据库行锁（SELECT FOR UPDATE）防止并发审核冲突
- **状态非法流转**: 校验当前状态是否允许目标状态流转，非法流转返回错误码2002
- **权限不足**: 非订单所属服务提供者或管理员，返回错误码403

**并发与重复操作处理策略**:
1. **订单创建**: 使用 `client_request_id` 唯一索引实现幂等，相同请求ID直接返回已创建订单
2. **订单审核**: 使用数据库事务 + 行锁，确保同一订单同时只能被一个操作处理
3. **档期锁定**: 使用数据库唯一索引 + 事务，确保档期不会被重复占用
4. **状态流转**: 使用乐观锁（version字段）或悲观锁（SELECT FOR UPDATE）防止并发修改

```
┌──────────────────────────────────────────────────────────────┐
│              订单状态流转图（拆状态设计）                      │
└──────────────────────────────────────────────────────────────┘

【业务主状态流转】:
                    ┌─────────────┐
                    │  用户提交   │
                    │   订单      │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │待审核(CREATED=0)│
                    │payment_status=UNPAID(0)│
                    │refund_status=NONE(0)│
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
    ┌───────────┐   ┌───────────┐   ┌───────────┐
    │服务提供者 │   │服务提供者 │   │ 用户取消  │
    │同意订单  │   │拒绝订单  │   │          │
    └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
          │               │               │
          ▼               ▼               ▼
    ┌───────────┐   ┌───────────┐   ┌───────────┐
    │已同意(CONFIRMED=1)│ │已拒绝(REJECTED=10)│ │已取消(CANCELLED=11)│
    │payment_status=UNPAID(0)│ │[终态]│ │[终态]│
    └─────┬─────┘   └───────────┘   └───────────┘
          │
          │ 管理员确认付款
          │ payment_status: UNPAID(0) → PAID(1)
          │
          │ [自动流转]
          ▼
    ┌───────────┐
    │待服务(SERVING=3)│
    │payment_status=PAID(1)│
    │refund_status=NONE(0)│
    └─────┬─────┘
          │
          ├─── 服务提供者确认完成
          │    │
          │    ▼
          │    ┌───────────┐
          │    │已完成(FINISHED=4)│
          │    │[终态]│
          │    └───────────┘
          │
          └─── 用户申请退款
               │ refund_status: NONE(0) → APPLY(1)
               │
               ▼
          ┌───────────┐
          │待服务(SERVING=3)│
          │payment_status=PAID(1)│
          │refund_status=APPLY(1)│
          └─────┬─────┘
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
    ┌───────────┐ ┌───────────┐
    │管理员同意│ │管理员拒绝│
    │退款      │ │退款      │
    └─────┬─────┘ └─────┬─────┘
          │             │
          │ refund_status: APPLY(1) → APPROVED(2)
          │             │ refund_status: APPLY(1) → REJECTED(3)
          │             │
          │             ▼
          │       ┌───────────┐
          │       │待服务(SERVING=3)│
          │       │refund_status=REJECTED(3)│
          │       └───────────┘
          │
          │ 管理员确认退款完成
          │ refund_status: APPROVED(2) → COMPLETED(4)
          │ payment_status: PAID(1) → PARTIAL_REFUND(2) 或 FULL_REFUND(3)
          │
          ▼
    ┌───────────┐
    │待服务(SERVING=3)│
    │payment_status=PARTIAL_REFUND(2)│
    │refund_status=COMPLETED(4)│
    └───────────┘

【支付状态流转】:
UNPAID(0) ──[管理员确认付款]──→ PAID(1)
    │                              │
    │                              │ [部分退款]
    │                              ↓
    │                        PARTIAL_REFUND(2)
    │                              │
    │                              │ [全额退款]
    │                              ↓
    └──────────────────────── FULL_REFUND(3)

【退款状态流转】:
NONE(0) ──[用户申请退款]──→ APPLY(1)
                              │
                    ┌─────────┴─────────┐
                    │                   │
        [管理员同意] │                   │ [管理员拒绝]
                    ↓                   ↓
            APPROVED(2)          REJECTED(3)
                    │
        [管理员确认退款完成]
                    ↓
            COMPLETED(4)

【异常流程】:
- 档期冲突 → 返回错误，不允许创建订单
- 重复提交 → 幂等键校验，返回已存在订单
- 状态非法 → 返回错误码2002
- 权限不足 → 返回错误码403
- 状态组合非法 → 返回错误码2002（状态组合不符合业务规则）
```

### 2.4 付款确认流程

```
┌──────────────────────────────────────────────────────────────┐
│                      付款确认流程                             │
└──────────────────────────────────────────────────────────────┘

主持人同意订单后
    │
    ▼
订单状态变为：已同意(1)
    │
    ▼
通知用户：订单已同意，请线下付款
    │
    ▼
用户线下付款（微信转账/银行转账等）
    │
    ▼
用户告知管理员已付款
    │
    ▼
管理员登录管理后台
    │
    ▼
找到对应订单
    │
    ▼
┌─────────────────────────────┐
│ 管理员操作：确认付款         │
│                             │
│ 1. 上传付款凭证（截图）      │
│ 2. 填写实际付款金额          │
│ 3. 填写付款备注（选填）      │
│ 4. 确认提交                  │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│ 系统处理：                   │
│ 1. 保存付款凭证              │
│ 2. 记录付款信息              │
│ 3. 更新订单状态为：已付款    │
│ 4. 自动流转为：待服务        │
│ 5. 记录操作日志              │
└──────────────┬──────────────┘
               │
               ▼
通知用户：付款已确认
通知主持人：订单已付款，请按时服务
               │
               ▼
等待服务日到来
```

### 2.5 付款凭证上传流程

```
订单状态：已同意(1)
    │
    ▼
用户线下付款
    │
    ▼
用户上传付款凭证（可选）
    │
    ├─── 选择图片
    │
    ├─── 上传到服务器
    │
    └─── 保存到订单表 user_payment_voucher 字段
    │
    ▼
通知管理员：用户已上传付款凭证
    │
    ▼
管理员查看凭证
    │
    ├─── 确认付款
    │    │
    │    ├─── 上传管理员确认凭证
    │    ├─── 填写付款金额
    │    └─── 确认付款
    │
    └─── 或联系用户确认
```

### 2.6 退款处理流程

```
┌──────────────────────────────────────────────────────────────┐
│                      退款处理流程                             │
└──────────────────────────────────────────────────────────────┘

用户申请退款
    │
    ├─── 填写退款原因
    │
    ▼
订单状态变为：退款审核中(5)
    │
    ▼
通知管理员：有新退款申请
    │
    ▼
管理员登录管理后台
    │
    ▼
查看退款申请详情
    │
    ├─── 查看订单信息
    ├─── 查看付款凭证
    └─── 查看退款原因
    │
    ▼
┌─────────────────────────────┐
│ 管理员审核决定               │
└──────────────┬──────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐ ┌─────────────┐
│  同意退款   │ │  拒绝退款   │
└──────┬──────┘ └──────┬──────┘
       │               │
       ▼               ▼
┌─────────────────┐ ┌─────────────────┐
│ 管理员操作：     │ │ 管理员操作：     │
│                 │ │                 │
│ 1. 线下退款     │ │ 1. 填写拒绝原因  │
│ 2. 上传退款凭证 │ │ 2. 确认提交      │
│ 3. 填写退款金额 │ └────────┬────────┘
│ 4. 确认提交     │          │
└────────┬────────┘          │
         │                   │
         ▼                   ▼
订单状态：已退款(-3)    订单恢复原状态
         │                   │
         ▼                   ▼
通知用户：退款成功      通知用户：退款被拒
释放档期                显示拒绝原因
         │                   │
         ▼                   ▼
     流程结束           流程结束
```

### 2.7 分享功能流程

```
用户浏览内容
    │
    ├─── 主持人详情页
    │    │
    │    ├─── 点击分享按钮
    │    │
    │    ├─── 选择分享渠道（微信好友/朋友圈）
    │    │
    │    ├─── 生成分享卡片
    │    │    ├─── 标题：主持人姓名
    │    │    ├─── 描述：个性签名
    │    │    ├─── 图片：主持人头像/封面
    │    │    └─── 链接：主持人详情页
    │    │
    │    └─── 记录分享日志
    │
    ├─── 动态详情页
    │    │
    │    ├─── 点击分享按钮
    │    │
    │    ├─── 生成分享卡片
    │    │    ├─── 标题：动态标题
    │    │    ├─── 描述：动态内容摘要
    │    │    ├─── 图片：动态封面/第一张图片
    │    │    └─── 链接：动态详情页
    │    │
    │    └─── 记录分享日志
    │
    └─── 订单详情页
         │
         ├─── 点击分享按钮
         │
         ├─── 生成分享卡片
         │    ├─── 标题：订单信息
         │    ├─── 描述：主持人+日期
         │    ├─── 图片：主持人头像
         │    └─── 链接：订单详情页（需登录）
         │
         └─── 记录分享日志
```

### 2.8 评价流程

```
┌──────────────────────────────────────────────────────────────┐
│                        评价流程                               │
└──────────────────────────────────────────────────────────────┘

订单状态变为：已完成(4)
    │
    ▼
系统发送通知：邀请用户评价
    │
    ▼
用户进入订单详情
    │
    ▼
点击"评价"按钮
    │
    ▼
┌─────────────────────────────┐
│ 用户填写评价：               │
│                             │
│ 1. 选择评分（1-5星，必填）   │
│ 2. 填写评价内容（必填）      │
│ 3. 上传图片（选填，最多9张） │
│ 4. 选择是否匿名（默认否）    │
│ 5. 提交评价                  │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│ 系统处理：                   │
│ 1. 保存评价记录              │
│ 2. 更新订单评价状态          │
│ 3. 更新主持人评分统计        │
└──────────────┬──────────────┘
               │
               ▼
评价发布成功
               │
               ▼
通知主持人：收到新评价
               │
               ▼
主持人可以回复评价
               │
               ▼
用户可查看回复
```

---

## 三、主持人业务流程

### 3.1 主持人入驻流程

```
┌──────────────────────────────────────────────────────────────┐
│                     主持人入驻流程                            │
└──────────────────────────────────────────────────────────────┘

管理员登录管理后台
    │
    ▼
进入主持人管理模块
    │
    ▼
点击"添加主持人"
    │
    ▼
┌─────────────────────────────┐
│ 填写主持人信息：             │
│                             │
│ 1. 基本信息                  │
│    - 姓名（必填）            │
│    - 手机号（必填）          │
│    - 微信号（选填）          │
│    - 性别（选填）            │
│    - 出生日期（选填）        │
│                             │
│ 2. 展示信息                  │
│    - 头像（必填）            │
│    - 封面图（选填）          │
│    - 个性签名（选填）        │
│    - 个人介绍（选填）        │
│    - 标签（多选）            │
│    - 从业年限（选填）        │
│                             │
│ 3. 关联会员账号（选填）      │
│    - 绑定已有会员            │
│    - 或新建会员账号          │
└──────────────┬──────────────┘
               │
               ▼
保存主持人信息
               │
               ▼
┌─────────────────────────────┐
│ 配置服务套餐：               │
│                             │
│ 1. 添加基础套餐              │
│    - 套餐名称                │
│    - 套餐描述                │
│    - 各场次价格              │
│                             │
│ 2. 添加增值服务（可选）      │
│    - 服务名称                │
│    - 服务描述                │
│    - 服务价格                │
│    - 计费模式                │
└──────────────┬──────────────┘
               │
               ▼
通知主持人：账号已创建
               │
               ▼
主持人登录小程序
    │
    ▼
自动识别主持人身份
    │
    ▼
进入主持人工作台
```

### 3.2 档期管理流程

```
┌──────────────────────────────────────────────────────────────┐
│                      档期管理流程                             │
└──────────────────────────────────────────────────────────────┘

主持人进入档期管理
    │
    ▼
查看档期日历
    │
    ├─── 绿色：空闲可预约
    ├─── 灰色：休息
    └─── 红色：已预订
    │
    ▼
选择日期和场次
    │
    ▼
┌─────────────────────────────┐
│ 设置档期状态：               │
│                             │
│ 1. 空闲（默认）              │
│    - 可被用户预约            │
│    - 可设置价格调整          │
│                             │
│ 2. 休息                      │
│    - 不可被预约              │
│    - 通常用于个人休假        │
│                             │
│ 已预订状态由订单自动设置     │
└──────────────┬──────────────┘
               │
               ▼
保存档期设置
               │
               ▼
用户端同步更新档期显示
```

### 3.3 动态发布流程

```
┌──────────────────────────────────────────────────────────────┐
│                      动态发布流程                             │
└──────────────────────────────────────────────────────────────┘

主持人进入动态管理
    │
    ▼
点击"发布动态"
    │
    ▼
选择动态类型
    │
    ├─── 图文动态
    │    │
    │    ▼
    │    ┌─────────────────────────────┐
    │    │ 填写内容：                   │
    │    │ 1. 选择分类                  │
    │    │ 2. 编写文字内容              │
    │    │ 3. 上传图片（最多9张）       │
    │    └─────────────────────────────┘
    │
    └─── 视频动态
         │
         ▼
         ┌─────────────────────────────┐
         │ 填写内容：                   │
         │ 1. 选择分类                  │
         │ 2. 编写文字内容              │
         │ 3. 上传视频                  │
         │ 4. 设置视频封面              │
         └─────────────────────────────┘
    │
    ▼
提交发布
    │
    ▼
┌─────────────────────────────┐
│ 系统处理：                   │
│                             │
│ 若开启审核：                 │
│   状态 = 待审核              │
│   等待管理员审核             │
│                             │
│ 若未开启审核：               │
│   状态 = 已发布              │
│   直接展示给用户             │
└─────────────────────────────┘
```

---

## 四、管理端业务流程

### 4.1 DIY页面装修流程

```
┌──────────────────────────────────────────────────────────────┐
│                    DIY页面装修流程                            │
└──────────────────────────────────────────────────────────────┘

管理员进入主持人管理
    │
    ▼
选择主持人
    │
    ▼
点击"页面装修"按钮
    │
    ▼
┌─────────────────────────────┐
│ 检查是否已有DIY页面          │
└──────────────┬──────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐ ┌─────────────┐
│  已有页面   │ │  无页面     │
└──────┬──────┘ └──────┬──────┘
       │               │
       │               ▼
       │       创建新DIY页面
       │               │
       └───────┬───────┘
               │
               ▼
进入装修编辑器（拖拉拽模式）
    │
    ├─── 左侧：组件库
    │    ├─── 媒体轮播
    │    ├─── 主持人信息
    │    ├─── 档期查询
    │    ├─── 服务选项
    │    ├─── 评价展示
    │    ├─── 操作按钮组
    │    ├─── 视频作品
    │    └─── 图文作品
    │
    ├─── 中间：画布区域
    │    ├─── 实时预览
    │    ├─── 拖拽组件
    │    ├─── 调整顺序
    │    └─── 删除组件
    │
    └─── 右侧：属性面板
         ├─── 组件配置
         ├─── 样式设置
         └─── 数据绑定
    │
    ▼
配置组件属性
    │
    ├─── 设置组件数据
    ├─── 调整样式
    └─── 设置间距边距
    │
    ▼
实时预览效果
    │
    ▼
保存页面
    │
    ▼
┌─────────────────────────────┐
│ 系统处理：                   │
│ 1. 保存页面数据到数据库      │
│ 2. 更新主持人关联的页面ID    │
│ 3. 生成预览链接              │
└──────────────┬──────────────┘
               │
               ▼
可选择：预览、发布、继续编辑
    │
    ├─── 预览：在新窗口查看效果
    ├─── 发布：应用到小程序
    └─── 继续编辑：返回编辑器
```

### 4.2 日常运营流程

```
┌──────────────────────────────────────────────────────────────┐
│                      日常运营流程                             │
└──────────────────────────────────────────────────────────────┘

管理员登录管理后台
    │
    ▼
查看仪表盘
    │
    ├─── 今日订单统计
    ├─── 待处理事项
    │    ├─── 待确认付款订单
    │    ├─── 待审核退款
    │    ├─── 待审核评价
    │    └─── 待审核动态
    │
    ▼
处理待办事项

【待确认付款】
    │
    ├─── 查看订单详情
    ├─── 确认用户已付款
    ├─── 上传付款凭证
    └─── 确认付款

【待审核退款】
    │
    ├─── 查看退款申请
    ├─── 查看订单信息
    ├─── 联系用户确认
    ├─── 决定同意或拒绝
    │    ├─── 同意：线下退款 + 上传凭证
    │    └─── 拒绝：填写拒绝原因
    │
    ▼
处理完成
```

### 4.2 内容管理流程

```
管理员进入内容管理
    │
    ├─── 公告管理
    │    │
    │    ├─── 添加公告
    │    │    ├─── 填写标题、内容
    │    │    ├─── 上传封面图（可选）
    │    │    ├─── 设置链接（可选）
    │    │    ├─── 选择目标用户
    │    │    ├─── 设置是否置顶
    │    │    └─── 发布
    │    │
    │    ├─── 编辑公告
    │    └─── 删除公告
    │
    └─── 轮播图管理
         │
         ├─── 添加轮播图
         │    ├─── 上传图片
         │    ├─── 设置链接（主持人/动态/URL）
         │    ├─── 选择位置（首页/详情页等）
         │    ├─── 设置排序
         │    ├─── 设置有效期
         │    └─── 保存
         │
         ├─── 编辑轮播图
         └─── 删除轮播图
```

### 4.3 数据报表流程

```
┌──────────────────────────────────────────────────────────────┐
│                      数据报表流程                             │
└──────────────────────────────────────────────────────────────┘

管理员进入统计报表
    │
    ▼
选择报表类型
    │
    ├─── 订单统计
    │    ├─── 按日期统计
    │    ├─── 按主持人统计
    │    ├─── 按状态统计
    │    └─── 导出报表
    │
    ├─── 主持人统计
    │    ├─── 订单量排名
    │    ├─── 收入排名
    │    └─── 评分排名
    │
    ├─── 会员统计
    │    ├─── 新增会员
    │    └─── 活跃会员
    │
    └─── 评价统计
         ├─── 好评率
         └─── 评分分布
```

---

## 五、异常处理流程

### 5.1 档期冲突处理

```
┌──────────────────────────────────────────────────────────────┐
│                     档期冲突处理                              │
└──────────────────────────────────────────────────────────────┘

用户提交订单时
    │
    ▼
系统检查档期状态
    │
    ├─── 档期空闲 → 正常创建订单
    │
    └─── 档期已被占用
         │
         ▼
         返回错误：该档期已被预约
         │
         ▼
         提示用户选择其他日期或场次
```

### 5.2 订单超时处理（已移至第七章详细说明）

订单超时处理流程详见"七、订单超时自动处理"章节。

```
┌──────────────────────────────────────────────────────────────┐
│                     订单超时处理                              │
└──────────────────────────────────────────────────────────────┘

订单处于"待审核"状态
    │
    ▼
定时任务检查（每小时）
    │
    ├─── 主持人超过24小时未处理
    │    │
    │    ▼
    │    发送提醒通知给主持人
    │
    ├─── 主持人超过48小时未处理
    │    │
    │    ▼
    │    可选：自动同意或通知管理员
    │
    └─── 正常：继续等待
```

### 5.3 退款争议处理

```
┌──────────────────────────────────────────────────────────────┐
│                     退款争议处理                              │
└──────────────────────────────────────────────────────────────┘

用户申请退款
    │
    ▼
管理员收到通知
    │
    ▼
查看退款申请
    │
    ├─── 正常退款：直接处理
    │
    └─── 存在争议
         │
         ▼
         联系用户了解情况
         │
         ▼
         联系主持人了解情况
         │
         ▼
         综合判断决定
         │
         ├─── 全额退款
         ├─── 部分退款
         └─── 拒绝退款
         │
         ▼
         记录处理结果
```

---

## 六、消息通知系统

### 6.1 消息中心功能

**功能说明**:
- 小程序端提供消息中心入口
- 显示所有系统消息和业务消息
- 支持消息分类查看
- 未读消息角标提示
- 点击消息可跳转到相关页面

**消息类型**:
| 消息类型 | 说明 | 触发时机 |
|---------|------|---------|
| order_status | 订单状态变更 | 订单状态变化时 |
| order_timeout | 订单超时提醒 | 订单即将超时或已超时 |
| review_reply | 评价回复 | 主持人回复评价 |
| system_notice | 系统公告 | 管理员发布公告 |

### 6.2 消息推送流程

```
订单状态变更
    │
    ▼
系统生成消息记录
    │
    ├─── 保存到消息表
    │
    ├─── 发送小程序订阅消息（可选）
    │
    └─── 更新用户未读消息数
    │
    ▼
用户打开小程序
    │
    ▼
消息中心显示新消息
    │
    ▼
用户点击消息
    │
    ▼
跳转到相关页面（订单详情等）
    │
    ▼
标记消息为已读
```

### 6.3 通知渠道

- **小程序订阅消息**: 主要通知渠道（需用户授权）
- **系统内消息**: 消息中心记录（所有用户可见）
- **微信客服**: 使用微信小程序自带客服功能

---

## 七、订单超时自动处理

### 7.1 超时规则配置

**配置项**:
- 待审核超时时间（默认48小时）
- 已同意未付款超时时间（默认72小时）
- 是否自动拒绝超时订单
- 是否自动取消超时订单
- 超时前提醒时间（如24小时前）

### 7.2 超时处理流程

```
定时任务（每小时执行）
    │
    ▼
检查待审核订单
    │
    ├─── 超过48小时未处理
    │    │
    │    ├─── 发送提醒通知给主持人
    │    │
    │    └─── 超过72小时仍未处理
    │         │
    │         ├─── 自动拒绝（如果开启）
    │         │    │
    │         │    ├─── 更新订单状态为已拒绝
    │         │    ├─── 释放档期
    │         │    ├─── 发送通知给用户
    │         │    └─── 记录超时日志
    │         │
    │         └─── 或通知管理员处理
    │
    ▼
检查已同意未付款订单
    │
    ├─── 超过72小时未付款
    │    │
    │    ├─── 发送提醒通知给用户
    │    │
    │    └─── 超过96小时仍未付款
    │         │
    │         ├─── 自动取消（如果开启）
    │         │    │
    │         │    ├─── 更新订单状态为已取消
    │         │    ├─── 释放档期
    │         │    ├─── 发送通知给用户和主持人
    │         │    └─── 记录超时日志
    │         │
    │         └─── 或通知管理员处理
```

### 7.3 超时日志记录

所有超时处理操作都会记录到`wedding_order_timeout_log`表，包括：
- 订单信息
- 超时类型
- 超时小时数
- 处理动作
- 处理时间

## 八、数据统计与分析

### 8.1 核心指标

| 指标 | 说明 | 计算方式 |
|-----|------|---------|
| 订单总量 | 总订单数 | COUNT(orders) |
| 成交金额 | 已完成订单金额 | SUM(completed_orders.amount) |
| 订单转化率 | 成交订单/总订单 | completed / total |
| 平均客单价 | 成交金额/成交单数 | total_amount / order_count |
| 用户复购率 | 复购用户/总用户 | repeat_users / total_users |
| 主持人好评率 | 好评数/评价总数 | good_reviews / total_reviews |
| 主持人接单率 | 已同意订单/总订单 | approved / total |
| 平均响应时间 | 主持人平均审核时间 | AVG(approve_time - create_time) |
| 服务完成率 | 已完成订单/已付款订单 | completed / paid |

### 8.2 统计维度

- **时间维度**: 日、周、月、年
- **主持人维度**: 按主持人分组统计
- **状态维度**: 按订单状态分组统计
- **用户维度**: 按用户分组统计

### 8.3 数据报表

**管理端报表**:
- 仪表盘：今日数据、总览数据、趋势图
- 订单统计：按日期、主持人、状态统计
- 主持人统计：订单量、收入、评分排名
- 会员统计：新增、活跃、复购率

**主持人工作台**:
- 今日数据：新订单、待处理订单、今日服务
- 本月统计：订单数、收入、评价数、平均评分
- 最近订单列表
- 档期概览

---

## 九、角色权限详细说明

### 9.1 角色类型

| 角色标识 | 角色名称 | 说明 | 使用端 |
|---------|---------|------|-------|
| `user` | 普通用户 | 预约服务的客户 | 小程序 |
| `host` | 服务提供者 | 提供服务的人员（主持人/跟拍/管家） | 小程序 |
| `admin` | 管理员 | 系统管理人员 | PC管理端 |

### 9.2 角色判断逻辑

**小程序端角色判断**:
```typescript
interface MemberInfo {
    id: number
    is_provider: 0 | 1        // 是否服务提供者
    provider_id: number       // 服务提供者ID（如果is_provider=1）
    service_type: string      // 服务类型：host/photographer/butler
    role: 'user' | 'host'     // 角色标识
}

// 角色判断逻辑
if (member.is_provider === 1 && member.provider_id > 0) {
    role = 'host'  // 服务提供者
} else {
    role = 'user'  // 普通用户
}
```

### 9.3 功能权限矩阵

| 功能模块 | 普通用户 | 服务提供者 | 管理员 |
|---------|---------|-----------|-------|
| **服务提供者相关** |
| 浏览服务提供者列表 | ✅ | ✅ | ✅ |
| 查看服务提供者详情 | ✅ | ✅ | ✅ |
| 查看档期 | ✅ | ✅ | ✅ |
| 收藏服务提供者 | ✅ | ❌ | ❌ |
| **标签管理** |
| 查看标签列表 | ✅ | ✅ | ✅ |
| 创建/编辑/删除标签 | ❌ | ❌ | ✅（仅管理员） |
| 设置服务提供者标签 | ❌ | ❌ | ✅（仅管理员，在编辑服务提供者时设置） |
| **订单相关** |
| 创建订单 | ✅ | ❌ | ✅ |
| 查看我的订单 | ✅ | ✅ | ✅ |
| 取消订单 | ✅ | ❌ | ✅ |
| 申请退款 | ✅ | ❌ | ❌ |
| 审核订单（同意/拒绝） | ❌ | ✅ | ✅ |
| 确认服务完成 | ❌ | ✅ | ✅ |
| 确认付款 | ❌ | ❌ | ✅ |
| 确认退款 | ❌ | ❌ | ✅ |
| 上传付款凭证 | ✅ | ❌ | ❌ |
| **评价相关** |
| 提交评价 | ✅ | ❌ | ❌ |
| 查看评价列表 | ✅ | ✅ | ✅ |
| 回复评价 | ❌ | ✅ | ❌ |
| 审核评价 | ❌ | ❌ | ✅ |
| **动态相关** |
| 浏览动态 | ✅ | ✅ | ✅ |
| 点赞动态 | ✅ | ✅ | ❌ |
| 评论动态 | ✅ | ✅ | ❌ |
| 发布动态 | ❌ | ✅ | ✅ |
| 删除动态 | ❌ | ✅（仅自己） | ✅ |
| 审核动态 | ❌ | ❌ | ✅ |
| **档期管理** |
| 查看档期 | ✅ | ✅ | ✅ |
| 设置档期 | ❌ | ✅（仅自己） | ✅ |
| **工作台** |
| 查看工作台 | ❌ | ✅ | ✅ |
| **消息相关** |
| 查看消息中心 | ✅ | ✅ | ✅ |
| 标记消息已读 | ✅ | ✅ | ✅ |
| 发送系统消息 | ❌ | ❌ | ✅ |
| **购物车相关** |
| 添加购物车 | ✅ | ❌ | ❌ |
| 管理购物车 | ✅ | ❌ | ❌ |
| 批量结算 | ✅ | ❌ | ❌ |

### 9.4 前端权限控制

**路由守卫示例**:
```typescript
router.beforeEach((to, from, next) => {
    const memberStore = useMemberStore()
    
    // 需要登录的页面
    if (to.meta.requiresAuth && !memberStore.isLogin) {
        next('/pages/login/index')
        return
    }
    
    // 需要服务提供者角色的页面
    if (to.meta.requiresHost && memberStore.role !== 'host') {
        uni.showToast({ title: '仅服务提供者可访问', icon: 'none' })
        next(false)
        return
    }
    
    next()
})
```

### 9.5 后端权限中间件

```php
// app/middleware/RoleCheck.php
class RoleCheck
{
    public function handle($request, \Closure $next, string $role = '')
    {
        $member = AuthService::getCurrentMember();
        
        if (empty($member)) {
            return json(['code' => 401, 'msg' => '未登录']);
        }
        
        $memberRole = $this->getMemberRole($member);
        
        if (!empty($role) && $memberRole !== $role) {
            return json(['code' => 403, 'msg' => '无权限访问']);
        }
        
        return $next($request);
    }
}
```

---

## 十、多服务类型筛选与预约设计

### 10.1 设计概述

系统支持多种服务类型的预约，包括：
- **主持人** (host): 婚礼主持人服务
- **跟拍** (photographer): 婚礼跟拍服务
- **管家** (butler): 婚礼管家服务

### 10.2 页面设计

**服务类型选择页** (`/pages/provider/category/index`):
- 显示所有服务类型
- 每个类型显示图标、名称、服务提供者数量
- 点击进入对应类型的列表页

**统一筛选列表页** (`/pages/provider/list/index`):
- 服务类型Tab切换（全部/主持人/跟拍/管家）
- 关键词搜索
- 标签筛选（不同服务类型显示不同标签，标签由管理员设置）
- 价格筛选、排序方式
- 档期筛选（选择日期和场次）

**标签说明**:
- 标签只能由管理员在管理端创建和管理
- 标签按服务类型区分，不同服务类型显示不同的标签选项
- 服务提供者不能自己设置标签，标签由管理员在编辑服务提供者时设置

**统一预约页面** (`/pages/order/create/index`):
- 根据服务类型动态显示不同的字段
- 主持人：场次选择、服务套餐、增值服务
- 跟拍：场次选择、机位选择、设备要求、风格偏好
- 管家：场次选择、团队人数、服务范围

### 10.3 场次定义

**统一场次定义**（所有服务类型共用）:
- 1: 早场（早司仪）
- 2: 午场（午宴）
- 3: 晚场（晚宴）

用户可以选择多个场次组合（如：早场+午场）

### 10.4 API接口

**获取服务类型列表**: `GET /api/provider/serviceTypes`

**统一筛选接口**: `GET /api/provider/list`
- 支持 `service_type` 参数筛选
- 支持标签、价格、日期、场次等筛选条件

**统一预约接口**: `POST /api/order/create`
- 包含 `service_type` 和 `provider_id`
- 根据 `service_type` 处理不同的业务逻辑

---

## 十一、购物车功能设计

### 11.1 功能概述

用户可以在浏览服务提供者时，将多个服务项目添加到购物车，然后一次性结算，创建多个订单。

**购物车支持**:
- 多个服务提供者（主持人、跟拍、管家）
- 同一服务提供者的多个场次
- 不同服务套餐
- 增值服务
- 不同预约日期

### 11.2 订单分组策略

**分组规则**:
- 同一服务提供者 + 同一预约日期 = 一个订单
- 不同服务提供者 = 不同订单
- 同一服务提供者但不同日期 = 不同订单

**示例**:
```
购物车内容：
1. 主持人A - 2025-03-15 - 早场+午场
2. 主持人A - 2025-03-15 - 晚场
3. 主持人B - 2025-03-15 - 全天
4. 跟拍C - 2025-03-15 - 早场

结算后生成订单：
订单1: 主持人A - 2025-03-15（合并1和2）
订单2: 主持人B - 2025-03-15
订单3: 跟拍C - 2025-03-15
```

### 11.3 购物车表结构

```sql
CREATE TABLE `wedding_cart` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0,
    `service_type` varchar(50) NOT NULL DEFAULT 'host',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0,
    `reservation_date` date NOT NULL,
    `package_id` int(10) UNSIGNED NOT NULL DEFAULT 0,
    `periods` varchar(50) NOT NULL DEFAULT '',
    `addon_ids` varchar(255) NOT NULL DEFAULT '',
    `subtotal` decimal(10,2) NOT NULL DEFAULT 0.00,
    `is_valid` tinyint(1) NOT NULL DEFAULT 1,
    `create_time` int(11) NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 11.4 API接口

**添加购物车**: `POST /api/cart/add`
**购物车列表**: `GET /api/cart/list`
**更新购物车**: `POST /api/cart/update`
**删除购物车**: `POST /api/cart/delete`
**批量结算**: `POST /api/cart/checkout`

### 11.5 业务逻辑

1. **添加时校验**: 校验档期可用性、价格有效性
2. **结算时校验**: 再次校验档期、价格，防止数据变更
3. **订单创建**: 按分组规则创建多个订单
4. **清空购物车**: 结算成功后清空已结算的购物车项

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-01

