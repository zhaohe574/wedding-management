# 婚庆管家 - 项目开发文档

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v1.0.0  
**创建日期**: 2025-12-31  
**目标平台**: 微信小程序

---

## 一、项目概述

### 1.1 项目简介

婚庆管家是一款为婚庆公司打造的多服务类型预约管理系统，主要功能包括：
- 服务提供者展示与查询（主持人、跟拍、管家等）
- 多服务类型预约下单
- 订单审核与管理
- 动态内容展示
- 统一的服务筛选与预约流程

### 1.2 核心特点

- **业务规则配置化**: 服务类型、档期规则、价格规则均通过配置与数据驱动，不在代码中硬编码
- **专注微信小程序**: 仅支持微信小程序平台
- **不集成支付**: 不提供在线支付功能，仅支持凭证上传模式
- **单站点运营**: 系统为单站点运营，不支持多租户

### 1.3 核心功能（行为描述）

#### 1.2.1 服务提供者相关功能

**功能1：服务类型筛选**
- **行为描述**: 当【用户】在【小程序首页或服务列表页】执行【选择服务类型筛选条件】
  - 系统应返回【对应服务类型的服务提供者列表】，并满足【按服务类型正确筛选、支持全部类型查看】
- **输入**: 服务类型代码（host/photographer/butler）或空（全部）
- **输出**: 服务提供者列表（包含服务类型、数量统计）
- **前置条件**: 用户已登录或未登录（未登录可浏览，登录后可收藏）
- **验收标准**: 
  - 筛选结果准确，数量统计正确
  - 响应时间 < 500ms
  - 支持缓存优化

**功能2：服务提供者浏览**
- **行为描述**: 当【用户】在【服务列表页】执行【浏览服务提供者】
  - 系统应返回【分页的服务提供者列表】，并满足【支持关键词搜索、标签筛选、价格筛选、档期筛选、排序】
- **输入**: 页码、每页数量、服务类型、关键词、标签ID、日期、场次、排序方式、价格范围
- **输出**: 分页列表（包含服务提供者基本信息、是否可预约）
- **前置条件**: 无（公开浏览）
- **验收标准**: 
  - 分页正确，筛选条件生效
  - 档期筛选准确（显示可预约状态）
  - 排序功能正常（默认/订单量/评分/价格）

**功能3：服务提供者详情查看**
- **行为描述**: 当【用户】在【服务列表页】执行【点击服务提供者卡片】
  - 系统应返回【服务提供者详细信息】，并满足【包含基本信息、套餐列表、增值服务、档期日历、评价列表】
- **输入**: 服务提供者ID
- **输出**: 服务提供者详情对象（包含所有关联数据）
- **前置条件**: 服务提供者存在且状态为正常
- **验收标准**: 
  - 详情数据完整准确
  - 档期日历正确显示
  - 评价列表分页正常

#### 1.2.2 订单相关功能

**功能4：创建预约订单**
- **行为描述**: 当【普通用户】在【服务提供者详情页】且【已选择日期、场次、套餐】下执行【提交订单】
  - 系统应返回【订单编号和订单金额】，并满足【档期已锁定、订单状态为待审核、记录状态日志、发送通知给服务提供者】
- **输入**: 
  - 必填：服务类型、服务提供者ID、预约日期、场次数组、套餐ID、联系人姓名、联系电话
  - 选填：增值服务数组、婚礼场地、备注、客户端请求ID（幂等键）
- **输出**: 订单ID、订单编号、订单总额
- **前置条件**: 
  - 用户已登录且角色为普通用户
  - 所选档期状态为空闲
  - 套餐和服务提供者状态正常
- **验收标准**: 
  - 订单创建成功，订单编号唯一
  - 档期状态更新为已预订
  - 订单状态为待审核(0)
  - 支持幂等（相同client_request_id不重复创建）
  - 状态日志记录正确
  - 服务提供者收到通知

**功能5：订单审核（同意/拒绝）**
- **行为描述**: 当【服务提供者】在【订单列表页】且【订单状态为待审核】下执行【同意/拒绝订单】
  - 系统应返回【操作结果】，并满足【更新订单状态、记录状态日志、发送通知给用户、拒绝时释放档期】
- **输入**: 订单ID、操作类型（同意/拒绝）、拒绝原因（拒绝时必填）
- **输出**: 操作结果、新订单状态
- **前置条件**: 
  - 用户已登录且角色为服务提供者
  - 订单属于该服务提供者
  - 订单状态为待审核(0)
- **验收标准**: 
  - 同意后状态变为已同意(1)
  - 拒绝后状态变为已拒绝(-1)，档期释放
  - 状态日志记录正确
  - 用户收到通知

**功能6：付款确认**
- **行为描述**: 当【管理员】在【管理端订单详情页】且【订单状态为已同意】下执行【确认付款】
  - 系统应返回【操作结果】，并满足【更新订单状态为已付款、自动流转为待服务、记录付款信息、发送通知】
- **输入**: 订单ID、付款凭证图片URL、付款金额、付款备注
- **输出**: 操作结果
- **前置条件**: 
  - 用户已登录且角色为管理员
  - 订单状态为已同意(1)
- **验收标准**: 
  - 订单状态更新为已付款(2)，自动流转为待服务(3)
  - 付款凭证保存成功
  - 状态日志记录正确
  - 用户和服务提供者收到通知

#### 1.2.3 非功能范围（系统不做什么）

**明确不支持的场景**:
1. **不集成第三方支付系统**: 系统不提供在线支付功能，仅支持凭证上传模式
2. **不支持多站点**: 系统为单站点运营，不支持多租户
3. **不支持多端适配**: 小程序仅支持微信平台，不做其他平台适配
4. **不支持在线客服系统**: 仅使用微信小程序自带客服功能，不开发独立客服系统
5. **不支持自动退款**: 退款需管理员手动确认，不支持自动退款
6. **不支持订单自动完成**: 服务完成需服务提供者手动确认
7. **不支持批量操作**: 不支持批量创建订单、批量审核等操作
8. **不支持订单修改**: 订单创建后不可修改，只能取消后重新创建
9. **不支持档期自动释放**: 订单取消/拒绝后需手动或定时任务释放档期
10. **不支持实时统计**: 统计数据通过定时任务计算，非实时查询

### 1.4 技术选型

**后端技术栈**:
| 技术 | 版本 | 说明 |
|-----|------|------|
| PHP | >= 8.0 | 服务端语言 |
| ThinkPHP | 8.0 | PHP框架 |
| MySQL | >= 5.7 | 数据库 |
| Redis | >= 5.0 | 缓存 |
| Nginx | >= 1.18 | Web服务器 |

**前端技术栈**:
| 技术 | 版本 | 说明 |
|-----|------|------|
| uni-app | 3.x | 跨端框架 |
| Vue | 3.x | 前端框架 |
| TypeScript | 5.x | 类型支持 |
| tuniao UI | V3 | UI组件库 |
| Pinia | 2.x | 状态管理 |
| Windi CSS | 3.x | 原子化CSS |

**管理端技术栈**:
| 技术 | 版本 | 说明 |
|-----|------|------|
| Vue | 3.x | 前端框架 |
| TypeScript | 5.x | 类型支持 |
| Element Plus | 2.x | UI组件库 |
| Tailwind CSS | 3.x | 原子化CSS |
| Vite | 5.x | 构建工具 |

---

## 二、项目架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           统一小程序（按角色区分功能）                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │  普通用户   │  │  主持人     │  │  管理员     │ │   │
│  │  │  (角色判断) │  │  (角色判断) │  │  (角色判断) │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              管理端（PC）                            │   │
│  │              (Vue3)                                 │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────┼───────────────────────────────────────────────────┘
          │ HTTPS
          ▼
┌─────────────────────────────────────────────────────────────┐
│                      Nginx                                   │
│                   (反向代理/负载均衡)                         │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   ThinkPHP 8.0 后端                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  API路由    │  │  中间件     │  │  控制器     │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│         └────────────────┼────────────────┘                 │
│                          ▼                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   服务层    │──│   模型层    │──│  验证器     │         │
│  └─────────────┘  └──────┬──────┘  └─────────────┘         │
└──────────────────────────┼──────────────────────────────────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
   │    MySQL    │  │    Redis    │  │   文件存储   │
   │   (数据库)   │  │   (缓存)    │  │   (OSS)     │
   └─────────────┘  └─────────────┘  └─────────────┘
```

### 2.2 目录结构

**后端目录结构**:
```
wedding-management-api/
├── app/
│   ├── controller/              # 控制器
│   │   ├── admin/               # 管理端控制器
│   │   │   ├── Config.php       # 配置管理
│   │   │   ├── ServiceType.php  # 服务类型管理
│   │   │   ├── Provider.php     # 服务提供者管理（统一）
│   │   │   ├── ProviderLabel.php # 服务提供者标签（仅管理员可管理）
│   │   │   ├── ProviderService.php # 服务提供者服务
│   │   │   ├── Order.php        # 订单管理
│   │   │   ├── Refund.php       # 退款管理
│   │   │   ├── Review.php       # 评价管理
│   │   │   ├── Dynamic.php      # 动态管理
│   │   │   ├── Statistics.php   # 数据统计
│   │   │   ├── Message.php      # 消息管理
│   │   │   ├── Content.php      # 内容管理（公告、轮播图）
│   │   │   └── Cron.php         # 定时任务管理
│   │   ├── api/                 # 小程序API控制器（统一接口）
│   │   │   ├── Auth.php         # 登录授权
│   │   │   ├── Provider.php     # 服务提供者查询（统一接口，支持多服务类型）
│   │   │   ├── Order.php        # 订单操作（按角色区分，支持多服务类型）
│   │   │   ├── Review.php       # 评价操作（所有用户）
│   │   │   ├── Dynamic.php      # 动态查询（所有用户）
│   │   │   ├── Member.php       # 会员中心
│   │   │   ├── Console.php      # 工作台（服务提供者）
│   │   │   ├── Schedule.php     # 档期管理（服务提供者）
│   │   │   ├── Profile.php      # 个人资料
│   │   │   ├── Message.php      # 消息中心
│   │   │   ├── Share.php        # 分享功能
│   │   │   └── Cart.php         # 购物车
│   ├── model/                   # 模型
│   │   ├── ServiceType.php      # 服务类型
│   │   ├── ServiceProvider.php  # 服务提供者（统一表）
│   │   ├── ServiceProviderLabel.php # 服务提供者标签
│   │   ├── ServiceProviderService.php # 服务提供者服务
│   │   ├── ServiceProviderSchedule.php # 服务提供者档期
│   │   ├── ServiceProviderFavorite.php # 收藏
│   │   ├── Order.php            # 订单
│   │   ├── OrderPeriod.php      # 订单场次
│   │   ├── OrderOption.php      # 订单选项
│   │   ├── OrderStatusLog.php   # 订单状态日志
│   │   ├── Review.php           # 评价
│   │   ├── RefundApply.php      # 退款申请
│   │   ├── Dynamic.php          # 动态
│   │   ├── DynamicComment.php   # 动态评论
│   │   ├── DynamicLike.php      # 动态点赞
│   │   ├── Member.php           # 会员
│   │   ├── Admin.php            # 管理员
│   │   ├── Message.php          # 消息
│   │   ├── MessageRead.php      # 消息已读记录
│   │   ├── Notice.php           # 公告
│   │   ├── Banner.php           # 轮播图
│   │   └── ShareLog.php         # 分享记录
│   ├── service/                 # 服务层
│   │   ├── admin/               # 管理端服务
│   │   ├── api/                 # API服务（统一服务，按角色权限区分）
│   │   └── core/                # 核心服务（服务抽象层）
│   │       ├── BaseServiceProviderService.php  # 服务提供者基础服务类
│   │       ├── ServiceProviderServiceFactory.php  # 服务工厂类
│   │       ├── provider/        # 具体服务实现
│   │       │   ├── HostServiceProviderService.php
│   │       │   ├── PhotographerServiceProviderService.php
│   │       │   └── ButlerServiceProviderService.php
│   ├── validate/                # 验证器
│   │   ├── Provider.php          # 服务提供者验证
│   │   ├── ProviderLabel.php     # 标签验证
│   │   ├── Order.php
│   │   ├── Review.php
│   │   └── Dynamic.php
│   ├── middleware/              # 中间件
│   │   ├── AdminAuth.php        # 管理员认证（管理端）
│   │   ├── ApiAuth.php          # API认证（小程序）
│   │   ├── RoleCheck.php        # 角色权限检查（小程序）
│   │   └── Cors.php             # 跨域处理
│   ├── dict/                    # 字典常量
│   │   ├── OrderStatus.php      # 订单状态
│   │   ├── ScheduleStatus.php   # 档期状态
│   │   ├── PeriodType.php       # 场次类型
│   │   └── ServiceType.php      # 服务类型
│   ├── helper/                  # 辅助类
│   │   ├── JwtHelper.php        # JWT处理
│   │   ├── WechatHelper.php     # 微信接口
│   │   ├── UploadHelper.php     # 上传处理
│   │   ├── MessageHelper.php   # 消息推送
│   │   └── ShareHelper.php     # 分享处理
│   ├── job/                     # 定时任务
│   │   ├── OrderTimeoutJob.php  # 订单超时处理任务
│   │   └── MessageSendJob.php   # 消息发送任务
│   ├── command/                 # 命令行任务
│   │   └── OrderTimeout.php     # 订单超时处理命令
│   └── common.php               # 公共函数
├── config/                      # 配置文件
│   ├── app.php
│   ├── database.php
│   ├── cache.php
│   ├── route.php
│   └── middleware.php
├── route/                       # 路由定义
│   ├── admin.php                # 管理端路由
│   └── api.php                  # API路由（统一路由，通过中间件区分权限）
├── database/                    # 数据库
│   ├── migrations/              # 迁移文件
│   └── seeds/                   # 种子数据
├── public/                      # 入口目录
│   ├── index.php
│   └── upload/                  # 上传目录
├── runtime/                     # 运行时目录
├── vendor/                      # 依赖包
├── .env                         # 环境配置
├── composer.json
└── README.md
```

**小程序前端目录结构**:
```
wedding-management-miniapp/
├── src/
│   ├── pages/                   # 页面（统一页面，按角色显示）
│   │   ├── index/               # 首页
│   │   ├── host/                # 主持人相关（所有用户）
│   │   │   ├── list/            # 主持人列表
│   │   │   ├── detail/          # 主持人详情
│   │   │   └── schedule/        # 档期查询
│   │   ├── order/               # 订单相关（按角色区分）
│   │   │   ├── create/          # 创建订单（普通用户）
│   │   │   ├── list/            # 订单列表（所有用户，内容不同）
│   │   │   └── detail/          # 订单详情（所有用户，操作不同）
│   │   ├── dynamic/             # 动态相关（所有用户）
│   │   │   ├── list/            # 动态列表
│   │   │   ├── detail/          # 动态详情
│   │   │   └── publish/         # 发布动态（主持人）
│   │   ├── member/              # 会员中心（所有用户）
│   │   │   ├── index/           # 个人中心（按角色显示不同内容）
│   │   │   ├── favorite/        # 我的收藏（普通用户）
│   │   │   ├── review/          # 我的评价（普通用户）
│   │   │   ├── console/         # 工作台（主持人）
│   │   │   ├── schedule/         # 档期管理（主持人）
│   │   │   └── profile/         # 个人资料（主持人）
│   │   ├── message/             # 消息中心（所有用户）
│   │   │   └── index/           # 消息列表
│   │   ├── share/               # 分享相关
│   │   │   └── card/            # 分享卡片
│   │   └── login/               # 登录页
│   ├── components/              # 公共组件
│   │   ├── host-card/           # 主持人卡片
│   │   ├── order-card/          # 订单卡片
│   │   ├── dynamic-card/        # 动态卡片
│   │   ├── date-picker/         # 日期选择器
│   │   ├── period-picker/       # 场次选择器
│   │   ├── empty-state/         # 空状态
│   │   ├── message-badge/        # 消息角标
│   │   └── share-button/        # 分享按钮
│   ├── stores/                  # 状态管理
│   │   ├── member.ts            # 会员状态（包含角色信息）
│   │   ├── host.ts              # 主持人状态
│   │   ├── app.ts               # 应用状态
│   │   └── message.ts           # 消息状态
│   ├── composables/             # 组合式函数
│   │   ├── useAuth.ts           # 认证Hook（包含角色判断）
│   │   ├── useRole.ts           # 角色权限Hook
│   │   ├── useOrder.ts          # 订单Hook
│   │   ├── useMessage.ts       # 消息Hook
│   │   └── useShare.ts          # 分享Hook
│   ├── api/                     # API接口
│   │   ├── auth.ts              # 认证接口
│   │   ├── host.ts              # 主持人接口
│   │   ├── order.ts             # 订单接口
│   │   ├── dynamic.ts           # 动态接口
│   │   ├── member.ts            # 会员接口
│   │   ├── message.ts            # 消息接口
│   │   └── share.ts             # 分享接口
│   ├── utils/                   # 工具函数
│   │   ├── request.ts           # 请求封装
│   │   ├── storage.ts           # 存储封装
│   │   ├── date.ts              # 日期处理
│   │   └── common.ts            # 通用工具
│   ├── static/                  # 静态资源
│   │   ├── images/
│   │   └── icons/
│   ├── styles/                  # 样式文件
│   │   └── common.scss
│   ├── App.vue
│   ├── main.ts
│   ├── manifest.json
│   ├── pages.json
│   └── uni.scss
├── .env.development
├── .env.production
├── package.json
├── tsconfig.json
├── vite.config.ts
└── windi.config.ts
```

**管理端目录结构**:
```
wedding-management-admin/
├── src/
│   ├── views/                   # 页面
│   │   ├── dashboard/           # 仪表盘
│   │   ├── host/                # 主持人管理
│   │   │   ├── list.vue         # 主持人列表
│   │   │   ├── detail.vue       # 主持人详情
│   │   │   ├── label.vue        # 标签管理
│   │   │   └── service.vue      # 服务管理
│   │   ├── order/               # 订单管理
│   │   │   ├── list.vue         # 订单列表
│   │   │   └── detail.vue       # 订单详情
│   │   ├── refund/              # 退款管理
│   │   ├── review/              # 评价管理
│   │   ├── dynamic/             # 动态管理
│   │   ├── config/              # 系统配置
│   │   ├── diy/                  # DIY页面装修
│   │   ├── message/             # 消息管理
│   │   ├── content/             # 内容管理
│   │   │   ├── notice.vue       # 公告管理
│   │   │   └── banner.vue       # 轮播图管理
│   │   ├── statistics/          # 数据统计
│   │   │   ├── dashboard.vue    # 仪表盘
│   │   │   ├── order.vue        # 订单统计
│   │   │   ├── host.vue         # 主持人统计
│   │   │   └── member.vue       # 会员统计
│   │   └── cron/                # 定时任务管理
│   │   │   ├── editor.vue       # 装修编辑器（拖拉拽）
│   │   │   ├── component-list.vue # 组件列表
│   │   │   └── preview.vue      # 预览窗口
│   │   └── login/               # 登录页
│   ├── components/              # 公共组件
│   ├── stores/                  # 状态管理
│   ├── api/                     # API接口
│   ├── utils/                   # 工具函数
│   ├── router/                  # 路由配置
│   ├── styles/                  # 样式文件
│   ├── App.vue
│   └── main.ts
├── public/
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

---

## 三、开发规范

### 3.1 代码规范

#### PHP 代码规范

**命名规范**:
```php
// 类名：大驼峰
class HostService {}
class OrderController {}

// 方法名：小驼峰
public function getPage() {}
public function createOrder() {}

// 变量名：小驼峰
$providerId = 1;
$orderStatus = 'pending';

// 常量：全大写+下划线
const ORDER_STATUS_PENDING = 0;
const ORDER_STATUS_APPROVED = 1;
```

**控制器规范**:
```php
<?php
namespace app\controller\api;

use app\service\api\ProviderService;
use think\Response;

/**
 * 服务提供者控制器（统一接口）
 */
class Provider extends BaseController
{
    /**
     * 获取服务提供者列表
     * @return Response
     */
    public function list(): Response
    {
        $params = $this->request->param([
            ['page', 1],
            ['page_size', 10],
            ['service_type', ''],
            ['keyword', ''],
            ['label_id', 0]
        ]);
        
        $service = new ProviderService();
        $result = $service->getPage($params);
        
        return $this->success($result);
    }
}
```

**服务层规范**:
```php
<?php
namespace app\service\api;

use app\model\ServiceProvider;

/**
 * 服务提供者服务（统一服务）
 */
class ProviderService
{
    protected ServiceProvider $model;
    
    public function __construct()
    {
        $this->model = new ServiceProvider();
    }
    
    /**
     * 获取分页列表
     * @param array $params 查询参数
     * @return array
     */
    public function getPage(array $params): array
    {
        $page = intval($params['page'] ?? 1);
        $pageSize = intval($params['page_size'] ?? 10);
        
        $query = $this->model->where('status', 1);
        
        // 服务类型筛选
        if (!empty($params['service_type'])) {
            $query->where('service_type', $params['service_type']);
        }
        
        // 关键词搜索
        if (!empty($params['keyword'])) {
            $query->whereLike('realname', '%' . $params['keyword'] . '%');
        }
        
        $total = $query->count();
        $list = $query->page($page, $pageSize)->select()->toArray();
        
        return [
            'list' => $list,
            'total' => $total,
            'page' => $page,
            'page_size' => $pageSize
        ];
    }
}
```

#### TypeScript 代码规范

**命名规范**:
```typescript
// 接口/类型：大驼峰
interface ProviderInfo {
    providerId: number
    realname: string
}

// 函数/方法：小驼峰
function getProviderList() {}
const createOrder = () => {}

// 常量：全大写+下划线
const ORDER_STATUS = {
    PENDING: 0,
    APPROVED: 1
}
```

**API 接口规范**:
```typescript
// api/provider.ts
import request from '@/utils/request'

export interface ProviderListParams {
    page?: number
    pageSize?: number
    keyword?: string
    labelId?: number
}

export interface ProviderInfo {
    providerId: number
    realname: string
    mobile: string
    headimg: string
    signature: string
}

/**
 * 获取服务提供者列表
 */
export function getProviderList(params: ProviderListParams = {}) {
    return request.get<ProviderInfo[]>('provider/list', params)
}

/**
 * 获取服务提供者详情
 */
export function getProviderInfo(providerId: number) {
    return request.get<ProviderInfo>(`provider/info/${providerId}`)
}
```

**组件规范**:
```vue
<template>
    <view class="provider-card" @click="handleClick">
        <image :src="provider.headimg" class="avatar" />
        <view class="info">
            <text class="name">{{ provider.realname }}</text>
            <text class="signature">{{ provider.signature }}</text>
        </view>
    </view>
</template>

<script setup lang="ts">
import { defineProps, defineEmits } from 'vue'

interface ProviderInfo {
    providerId: number
    realname: string
    headimg: string
    signature: string
}

const props = defineProps<{
    provider: ProviderInfo
}>()

const emit = defineEmits<{
    (e: 'click', providerId: number): void
}>()

const handleClick = () => {
    emit('click', props.provider.providerId)
}
</script>

<style lang="scss" scoped>
.host-card {
    @apply flex items-center p-4 bg-white rounded-lg;
}
.avatar {
    @apply w-16 h-16 rounded-full;
}
.info {
    @apply ml-3 flex-1;
}
.name {
    @apply text-lg font-bold;
}
.signature {
    @apply text-sm text-gray-500 mt-1;
}
</style>
```

### 3.2 Git 规范

**分支管理**:
```
main          # 主分支，生产环境
develop       # 开发分支
feature/*     # 功能分支
hotfix/*      # 热修复分支
release/*     # 发布分支
```

**提交信息规范**:
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
perf: 性能优化
test: 测试相关
chore: 构建/工具相关

示例:
feat: 添加主持人列表页面
fix: 修复订单创建时档期校验问题
docs: 更新API接口文档
```

### 3.3 数据库规范

**表命名**:
```sql
-- 使用小写字母+下划线
wedding_service_provider          -- 服务提供者表（统一表）
wedding_service_provider_label    -- 服务提供者标签表
wedding_order                      -- 订单表
wedding_order_period               -- 订单场次表
```

**字段命名**:
```sql
-- 使用小写字母+下划线
provider_id   -- 主键
realname      -- 真实姓名
create_time   -- 创建时间
update_time   -- 更新时间
is_deleted    -- 软删除标记
```

**必备字段**:
```sql
id            -- 主键，自增
create_time   -- 创建时间，int(11)
update_time   -- 更新时间，int(11)
```

**文件上传规范**:
- 图片格式：jpg, jpeg, png, webp
- 视频格式：mp4, mov
- 大小限制：根据类型不同（2MB-100MB）
- 尺寸限制：根据类型不同（最大1920x1080px）
- 前端需做压缩裁剪处理

**图片/视频规格要求**:
| 类型 | 格式 | 最大大小 | 最大尺寸 | 说明 |
|-----|------|---------|---------|------|
| 头像 | jpg, jpeg, png, webp | 2MB | 800x800px | 建议压缩到200x200px |
| 封面图 | jpg, jpeg, png, webp | 5MB | 1920x1080px | 建议压缩到750x422px |
| 动态图片 | jpg, jpeg, png, webp | 5MB | 1920x1080px | 建议压缩到750x422px |
| 凭证 | jpg, jpeg, png | 5MB | 1920x1080px | 保持原图清晰度 |
| 评价图片 | jpg, jpeg, png, webp | 5MB | 1920x1080px | 建议压缩到750x422px |
| 动态视频 | mp4, mov | 100MB | 1920x1080px | 最大时长5分钟，建议码率2Mbps |

### 3.4 API 响应规范

**成功响应**:
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        // 响应数据
    }
}
```

**分页响应**:
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "list": [],
        "total": 100,
        "page": 1,
        "page_size": 10
    }
}
```

**错误响应**:
```json
{
    "code": 2001,
    "msg": "订单不存在",
    "data": null
}
```

**状态码定义（分层设计）**:
| 状态码范围 | 模块 | 说明 |
|-----------|------|------|
| 0 | 成功 | 操作成功 |
| 1xxx | 通用错误 | 系统级错误 |
| 2xxx | 订单模块 | 订单相关错误 |
| 3xxx | 档期模块 | 档期相关错误 |
| 4xxx | 支付/退款模块 | 支付退款相关错误 |
| 5xxx | 评价模块 | 评价相关错误 |
| 6xxx | 动态模块 | 动态相关错误 |
| 7xxx | 服务提供者模块 | 服务提供者相关错误 |

**HTTP状态码**:
| 状态码 | 说明 |
|-------|------|
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 422 | 参数验证失败 |
| 500 | 服务器错误 |

**API版本控制**:
- 所有API路径包含版本号：`/api/v1/`
- 未来版本：`/api/v2/`（向后兼容）
- 版本号在路由层统一处理

**幂等性支持**:
- 下单接口：通过 `client_request_id` 参数实现幂等
- 退款接口：通过 `client_request_id` 参数实现幂等
- 数据库层面：`client_request_id` 字段设置唯一索引

---

## 四、环境配置

### 4.1 开发环境要求

**服务端**:
- PHP >= 8.0
- MySQL >= 5.7
- Redis >= 5.0
- Composer >= 2.0

**前端**:
- Node.js >= 18.0
- npm >= 9.0 或 yarn >= 1.22
- 微信开发者工具（最新版）

### 4.2 本地开发配置

**后端配置** (`.env`):
```ini
APP_DEBUG = true

[DATABASE]
TYPE = mysql
HOSTNAME = 127.0.0.1
DATABASE = Wedding_management
USERNAME = root
PASSWORD = 
HOSTPORT = 3306
CHARSET = utf8mb4
PREFIX = wedding_

[CACHE]
DRIVER = redis
HOSTNAME = 127.0.0.1
HOSTPORT = 6379

[JWT]
SECRET = your-jwt-secret-key
EXPIRE = 86400

[WECHAT]
APPID = your-appid
SECRET = your-secret
```

**小程序配置** (`.env.development`):
```ini
VITE_APP_BASE_URL = http://localhost:8000/api/
VITE_APP_UPLOAD_URL = http://localhost:8000/upload
```

**tuniao UI V3 配置** (`main.ts`):
```typescript
import { createApp } from 'vue'
import App from './App.vue'
import tuniaoUI from 'tuniao-ui'
import 'tuniao-ui/index.scss'

const app = createApp(App)
app.use(tuniaoUI)
app.mount('#app')
```

**tuniao UI V3 使用示例**:
```vue
<template>
    <view>
        <!-- 使用 tuniao UI 组件 -->
        <tn-button type="primary" @click="handleClick">
            按钮
        </tn-button>
        
        <tn-card>
            <tn-text>卡片内容</tn-text>
        </tn-card>
    </view>
</template>
```

### 4.3 生产环境配置

**Nginx 配置**:
```nginx
server {
    listen 80;
    server_name api.example.com;
    root /var/www/Wedding-management-api/public;
    index index.php;

    location / {
        if (!-e $request_filename) {
            rewrite ^(.*)$ /index.php?s=$1 last;
        }
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.0-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

---

## 五、部署说明

### 5.1 后端部署

```bash
# 1. 克隆代码
git clone https://github.com/xxx/Wedding-management-api.git
cd Wedding-management-api

# 2. 安装依赖
composer install --no-dev

# 3. 配置环境变量
cp .env.example .env
vim .env

# 4. 运行数据库迁移
php think migrate:run

# 5. 设置目录权限
chmod -R 755 runtime
chmod -R 755 public/upload
```

### 5.2 小程序部署

```bash
# 1. 克隆代码
git clone https://github.com/xxx/Wedding-management-miniapp.git
cd Wedding-management-miniapp

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.production.example .env.production
vim .env.production

# 4. 构建
npm run build:mp-weixin

# 5. 使用微信开发者工具打开 dist/build/mp-weixin 目录
# 6. 上传并提交审核
```

### 5.3 管理端部署

```bash
# 1. 克隆代码
git clone https://github.com/xxx/Wedding-management-admin.git
cd Wedding-management-admin

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.production.example .env.production
vim .env.production

# 4. 构建
npm run build

# 5. 将 dist 目录部署到 Nginx
```

---

## 六、常见问题

### Q1: 如何添加新的订单状态？

1. 在 `app/dict/OrderStatus.php` 中添加常量
2. 更新 `getStatus()` 方法返回值
3. 在相关服务中处理新状态的业务逻辑

### Q2: 如何添加新的API接口？

1. 在 `route/api.php` 中添加路由
2. 在对应控制器中添加方法
3. 在服务层实现业务逻辑
4. 前端添加API调用方法

### Q3: 如何处理图片上传？

使用 `UploadHelper` 类：
```php
$helper = new UploadHelper();
$url = $helper->upload($file, 'images/host');
```

---

## 七、架构优化方案

### 7.1 服务抽象层设计

**设计目标**: 避免在代码中使用大量 if-else 判断服务类型，通过抽象层统一处理多服务类型的差异化逻辑。

**架构设计**:
```
BaseServiceProviderService (基础服务类)
    ├── HostServiceProviderService (主持人服务实现)
    ├── PhotographerServiceProviderService (跟拍服务实现)
    └── ButlerServiceProviderService (管家服务实现)
```

**使用工厂模式**:
```php
// 服务工厂类
class ServiceProviderServiceFactory
{
    public static function getInstance(string $serviceType): BaseServiceProviderService
    {
        $classMap = [
            'host' => 'app\service\api\provider\HostServiceProviderService',
            'photographer' => 'app\service\api\provider\PhotographerServiceProviderService',
            'butler' => 'app\service\api\provider\ButlerServiceProviderService',
        ];
        
        return new $classMap[$serviceType]();
    }
}

// 使用示例
$service = ServiceProviderServiceFactory::getInstance($orderData['service_type']);
$price = $service->calculatePrice($orderData);
```

### 7.2 缓存策略

**缓存层级**:
- L1: 应用内存缓存（本地缓存）
- L2: Redis缓存（分布式缓存）
- L3: 数据库查询

**主要缓存场景**:
- 服务类型列表缓存（1小时）
- 服务提供者详情缓存（30分钟）
- 服务提供者列表缓存（10分钟，带筛选条件hash）
- 标签列表缓存（1小时）
- 配置信息缓存（24小时）

**缓存更新策略**:
- 主动清除：数据更新时清除相关缓存
- 定时清除：每天凌晨清除列表缓存

### 7.3 订单超时处理

**超时类型**:
- 待审核超时：服务提供者未在规定时间内审核
- 已同意未付款超时：用户未在规定时间内付款
- 付款超时：已付款但服务未完成

**实现方式**:
- 使用ThinkPHP命令行 + Cron定时任务
- 或使用队列方式（推荐）

**超时配置**:
```php
// 配置项：order_timeout_config
{
    "pending_timeout_hours": 48,      // 待审核超时小时数
    "pending_timeout_action": "auto_reject",  // 超时操作
    "approved_timeout_hours": 24,      // 已同意未付款超时小时数
    "approved_timeout_action": "auto_cancel"
}
```

**定时任务**:
```bash
# 每5分钟执行一次
*/5 * * * * cd /path/to/project && php think order:timeout
```

### 7.4 DIY页面装修功能

**功能概述**: 允许管理员通过可视化的拖拉拽方式，自定义服务提供者详情页的布局和样式。

**技术实现**:
- 前端：Vue 3 + vuedraggable + Element Plus
- 后端：保存页面配置到 `wedding_diy_page` 表
- 数据格式：JSON格式存储组件配置

**核心组件**:
- 媒体轮播组件
- 服务套餐组件
- 档期日历组件
- 评价列表组件
- 动态列表组件

**页面管理**:
- 创建页面模板
- 编辑页面配置
- 实时预览
- 应用模板

### 7.5 业务规则配置化设计（V1 即完成）

#### 7.5.1 设计目标

- 新增服务类型无需修改核心业务代码
- 档期规则可扩展，不依赖固定枚举
- 订单、价格、档期校验规则集中管理

#### 7.5.2 配置驱动原则

- 所有业务类型均来源于数据库配置
- Service 层不直接判断字符串或魔法数字
- 所有规则通过 Rule / Policy 对象执行

---

## 八、V1 版本设计边界与扩展能力说明

### 8.1 档期模型可扩展

- V1 已支持任意时间段形式的档期定义
- 固定场次仅作为默认模板存在
- 后续无需修改数据库结构即可支持新档期规则

### 8.2 服务类型可配置

- 服务类型来源于数据库配置
- 核心业务逻辑不依赖具体类型名称
- 新增服务类型仅需配置数据和扩展服务实现

### 8.3 业务规则不硬编码

- 所有业务校验集中于 Service / Rule 层
- 禁止在 Controller / Model 中直接写业务规则
- 状态流转、档期冲突、价格计算均通过规则对象处理

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-01

