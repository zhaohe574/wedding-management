# 婚庆管家 - 数据库设计文档

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v1.0.0  
**创建日期**: 2025-12-31

---

## 一、数据库概述

### 1.1 数据库信息

- **数据库类型**: MySQL 5.7+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_general_ci
- **表前缀**: wedding_
- **存储引擎**: InnoDB

### 1.2 表清单

| 序号 | 表名 | 说明 |
|-----|------|------|
| 1 | wedding_service_type | 服务类型表 |
| 2 | wedding_service_provider | 服务提供者表（统一表，包含主持人、跟拍、管家） |
| 3 | wedding_service_provider_label | 服务提供者标签表 |
| 4 | wedding_service_provider_service | 服务提供者服务表 |
| 5 | wedding_service_provider_schedule | 服务提供者档期表 |
| 6 | wedding_service_provider_favorite | 服务提供者收藏表 |
| 7 | wedding_order | 预约订单表 |
| 7 | wedding_order_period | 订单场次明细表 |
| 8 | wedding_order_option | 订单增值服务表 |
| 9 | wedding_order_status_log | 订单状态日志表 |
| 10 | wedding_review | 评价表 |
| 11 | wedding_refund_apply | 退款申请表 |
| 12 | wedding_dynamic | 动态表 |
| 13 | wedding_dynamic_comment | 动态评论表 |
| 14 | wedding_dynamic_like | 动态点赞表 |
| 15 | wedding_dynamic_category | 动态分类表 |
| 16 | wedding_member | 会员表 |
| 17 | wedding_admin | 管理员表 |
| 18 | wedding_admin_login_log | 管理员登录日志表 |
| 19 | wedding_config | 系统配置表 |
| 20 | wedding_diy_component | DIY组件注册表（支持动态注册新组件） |
| 21 | wedding_diy_page | DIY页面表 |
| 20 | wedding_message | 消息表 |
| 21 | wedding_message_read | 消息已读记录表 |
| 22 | wedding_notice | 公告表 |
| 23 | wedding_banner | 轮播图表 |
| 24 | wedding_share_log | 分享记录表 |
| 25 | wedding_order_timeout_log | 订单超时日志表 |
| 26 | wedding_cart | 购物车表 |
| 27 | wedding_combo_package | 组合套餐表 |
| 28 | wedding_combo_package_item | 组合套餐明细表 |

### 1.3 数据生命周期策略

**说明**：为每张表明确数据生命周期策略，包括是否支持逻辑删除、是否参与唯一约束、是否具有业务历史意义。

| 表名 | 数据生命周期策略 | 逻辑删除 | 唯一约束参与 | 业务历史意义 | 说明 |
|-----|----------------|---------|--------------|------------|------|
| **核心业务表** |
| wedding_order | 永久保留 | ❌ | - | ✅ | 订单具有业务历史意义，终态订单永久保留用于历史追溯 |
| wedding_order_period | 永久保留 | ❌ | - | ✅ | 订单场次明细，永久保留用于历史追溯 |
| wedding_order_option | 永久保留 | ❌ | - | ✅ | 订单增值服务明细，永久保留用于历史追溯 |
| wedding_order_status_log | 永久保留 | ❌ | - | ✅ | 状态变更历史，永久保留用于追溯（分区表，按月份分区） |
| wedding_service_provider_schedule | 永久保留 | ❌ | - | ✅ | 档期记录永久保留，用于历史追溯和数据分析 |
| wedding_refund_apply | 永久保留 | ❌ | - | ✅ | 退款申请记录，永久保留用于财务追溯 |
| wedding_review | 永久保留 | ❌ | - | ✅ | 评价记录，永久保留用于服务提供者评分统计 |
| **服务提供者相关** |
| wedding_service_provider | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ⚠️ | 删除后数据保留，但不再参与查询；provider_no唯一索引，逻辑删除后仍保持唯一 |
| wedding_service_provider_service | 物理删除+审计 | ❌ | - | ❌ | 无业务历史意义，建议物理删除；删除前记录审计日志 |
| wedding_service_provider_label | 支持逻辑删除 | ✅ | - | ❌ | 标签删除后数据保留，但不再使用 |
| wedding_service_provider_favorite | 物理删除 | ❌ | - | ❌ | 收藏关系，删除即物理删除 |
| **内容相关** |
| wedding_dynamic | 支持逻辑删除 | ✅ | - | ⚠️ | 删除后数据保留，但不再展示；用于统计和历史查询 |
| wedding_dynamic_comment | 支持逻辑删除 | ✅ | - | ❌ | 删除后数据保留，但不再展示 |
| wedding_dynamic_like | 物理删除 | ❌ | - | ❌ | 点赞关系，删除即物理删除 |
| wedding_dynamic_category | 支持逻辑删除 | ✅ | - | ❌ | 分类删除后数据保留，但不再使用 |
| **用户与系统** |
| wedding_member | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ⚠️ | 删除后数据保留，但不再参与查询；openid唯一索引，逻辑删除后仍保持唯一 |
| wedding_admin | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ⚠️ | 删除后数据保留，但不再参与查询；username唯一索引，逻辑删除后仍保持唯一 |
| wedding_admin_login_log | 永久保留 | ❌ | - | ✅ | 登录日志，永久保留用于安全审计（建议定期归档） |
| **内容管理** |
| wedding_notice | 支持逻辑删除 | ✅ | - | ⚠️ | 删除后数据保留，但不再展示；用于历史查询 |
| wedding_banner | 支持逻辑删除 | ✅ | - | ❌ | 删除后数据保留，但不再使用 |
| wedding_message | 永久保留 | ❌ | - | ✅ | 消息记录，永久保留用于历史查询 |
| wedding_message_read | 物理删除 | ❌ | - | ❌ | 已读记录，删除即物理删除 |
| **其他** |
| wedding_cart | 物理删除 | ❌ | - | ❌ | 购物车数据，删除即物理删除 |
| wedding_share_log | 永久保留 | ❌ | - | ✅ | 分享记录，永久保留用于数据分析 |
| wedding_order_timeout_log | 永久保留 | ❌ | - | ✅ | 超时日志，永久保留用于追溯（分区表，按月份分区） |
| wedding_config | 永久保留 | ❌ | ✅ | ✅ | 系统配置，永久保留；key唯一索引 |
| wedding_service_type | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ⚠️ | 删除后数据保留，但不再使用；type_code唯一索引，逻辑删除后仍保持唯一 |
| wedding_diy_component | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ❌ | 删除后数据保留，但不再使用；component_name唯一索引，逻辑删除后仍保持唯一 |
| wedding_diy_page | 支持逻辑删除 | ✅ | ✅（逻辑删除后仍唯一） | ⚠️ | 删除后数据保留，但不再使用；name唯一索引，逻辑删除后仍保持唯一 |

**唯一约束说明**：
- **逻辑删除的数据是否参与唯一约束**：
  - 支持逻辑删除的表，唯一索引必须考虑逻辑删除标记
  - 查询时自动过滤 `is_deleted=0` 的记录
  - 唯一索引在逻辑删除后仍保持唯一性（例如：provider_no、username等）
  - 示例：`wedding_service_provider.provider_no` 唯一索引，逻辑删除后仍唯一，但查询时自动过滤已删除记录

**数据保留策略**：
- **永久保留**：订单、状态日志、档期等具有业务历史意义的数据
- **逻辑删除**：服务提供者、会员等需要保留但不再使用的数据
- **物理删除**：购物车、点赞等无业务历史意义的数据

---

## 二、核心业务表

### 2.1 服务类型表 (wedding_service_type)

**说明**: 服务类型定义表（系统支持的所有业务类型）。系统通过该表识别所有可用服务类型，新增服务类型无需修改代码。

**数据生命周期策略**：
- 支持逻辑删除（is_deleted字段）
- 逻辑删除后数据保留，但不再参与查询
- type_code唯一索引，逻辑删除后仍保持唯一性
- 无业务历史意义，删除后不影响历史数据

```sql
CREATE TABLE `wedding_service_type` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `type_code` varchar(50) NOT NULL DEFAULT '' COMMENT '类型代码：host/photographer/butler',
    `type_name` varchar(50) NOT NULL DEFAULT '' COMMENT '类型名称：主持人/跟拍/管家',
    `icon` varchar(500) NOT NULL DEFAULT '' COMMENT '类型图标',
    `description` varchar(255) NOT NULL DEFAULT '' COMMENT '类型描述',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_type_code` (`type_code`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务类型定义表（系统支持的所有业务类型）';
```

**预置数据**:
```sql
INSERT INTO `wedding_service_type` (`type_code`, `type_name`, `icon`, `description`, `sort`, `status`, `create_time`) VALUES
('host', '主持人', '', '婚礼主持人服务', 1, 1, UNIX_TIMESTAMP()),
('photographer', '跟拍', '', '婚礼跟拍服务', 2, 1, UNIX_TIMESTAMP()),
('butler', '管家', '', '婚礼管家服务', 3, 1, UNIX_TIMESTAMP());
```

**说明**: 以上预置数据仅为系统初始化数据，非固定枚举。系统支持通过配置表动态添加新的服务类型。

### 2.2 服务提供者表 (wedding_service_provider)

**说明**: 统一的服务提供者表，包含主持人、跟拍、管家等所有服务类型。

**数据生命周期策略**：
- 支持逻辑删除（is_deleted字段）
- 逻辑删除后数据保留，但不再参与查询
- provider_no唯一索引，逻辑删除后仍保持唯一性
- 删除后不影响历史订单数据（订单通过provider_id关联）

```sql
CREATE TABLE `wedding_service_provider` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '关联会员ID',
    `service_type` varchar(50) NOT NULL DEFAULT 'host' COMMENT '服务类型：host/photographer/butler',
    `provider_no` varchar(32) NOT NULL DEFAULT '' COMMENT '服务提供者编号',
    `realname` varchar(50) NOT NULL DEFAULT '' COMMENT '真实姓名',
    `mobile` varchar(20) NOT NULL DEFAULT '' COMMENT '手机号码',
    `wechat` varchar(50) NOT NULL DEFAULT '' COMMENT '微信号',
    `headimg` varchar(500) NOT NULL DEFAULT '' COMMENT '头像',
    `cover` varchar(500) NOT NULL DEFAULT '' COMMENT '封面图',
    `sex` tinyint(1) NOT NULL DEFAULT 0 COMMENT '性别：0=保密，1=男，2=女',
    `birthday` varchar(20) NOT NULL DEFAULT '' COMMENT '出生日期',
    `id_card` varchar(30) NOT NULL DEFAULT '' COMMENT '身份证号',
    `signature` varchar(255) NOT NULL DEFAULT '' COMMENT '个性签名',
    `introduction` text COMMENT '个人介绍',
    `label_ids` varchar(255) NOT NULL DEFAULT '' COMMENT '管理员标签ID，逗号分隔（仅管理员可设置）',
    `custom_labels` text COMMENT '自定义标签（JSON数组），服务提供者自己设置的擅长标签' CHECK (JSON_VALID(`custom_labels`)),
    `experience_years` int(10) NOT NULL DEFAULT 0 COMMENT '从业年限',
    `diy_page_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '关联DIY页面ID',
    
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `order_count` int(10) NOT NULL DEFAULT 0 COMMENT '订单数量（缓存）',
    `review_count` int(10) NOT NULL DEFAULT 0 COMMENT '评价数量（缓存）',
    `avg_score` decimal(3,2) NOT NULL DEFAULT 5.00 COMMENT '平均评分（缓存）',
    `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0=否，1=是',
    PRIMARY KEY (`id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_status` (`status`),
    KEY `idx_diy_page_id` (`diy_page_id`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者表（统一表）';
```

**字段字典**:

| 字段名 | 字段类型 | 枚举值 | 业务含义 | 是否支持逻辑删除 | 禁止随意修改 |
|-------|---------|--------|---------|----------------|------------|
| service_type | varchar(50) | host/photographer/butler | 服务类型：主持人/跟拍/管家 | ❌ | ✅（创建后不可修改） |
| sex | tinyint(1) | 0=保密，1=男，2=女 | 性别 | ❌ | ❌ |
| status | tinyint(1) | 0=禁用，1=正常 | 服务提供者状态 | ❌ | ❌ |
| label_ids | varchar(255) | - | 管理员标签ID（逗号分隔），仅管理员可设置 | ❌ | ✅（仅管理员可修改） |
| custom_labels | text | JSON数组 | 自定义标签，服务提供者自己设置的擅长标签 | ❌ | ❌（服务提供者可修改） |
| is_deleted | tinyint(1) | 0=否，1=是 | 逻辑删除标记 | ✅（支持） | ❌ |

**custom_labels 字段说明**（JSON格式）:
```json
[
    {
        "name": "擅长户外婚礼",
        "color": "#FF6600",
        "create_time": 1705287600
    },
    {
        "name": "双语主持",
        "color": "#0066FF",
        "create_time": 1705287700
    }
]
```

**说明**: 
- 统一使用`wedding_service_provider`表管理所有服务类型（主持人、跟拍、管家等）
- 通过`service_type`字段区分不同的服务类型
- **扩展属性设计**：服务类型特有的字段（如跟拍的equipment、管家的team_size）存储在扩展表中，避免主表垂直扩展
- 支持逻辑删除（is_deleted字段），删除后数据保留用于历史追溯
- `service_type`创建后禁止修改，如需修改需删除后重新创建
- 如果已有`wedding_host`表数据，需要迁移到`wedding_service_provider`表（service_type='host'）
- 迁移完成后删除`wedding_host`表

### 2.3.1 服务提供者扩展表 (wedding_service_provider_extension)

**说明**: 
- **设计目的**：解决主表垂直扩展问题，支持新服务类型无需修改主表结构
- **存储方式**：使用JSON字段存储扩展属性，支持动态添加新属性
- **查询优化**：使用生成列和虚拟索引优化JSON字段查询性能
- **兼容性**：向后兼容，现有数据可迁移到扩展表

```sql
CREATE TABLE `wedding_service_provider_extension` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `service_type` varchar(50) NOT NULL DEFAULT '' COMMENT '服务类型：host/photographer/butler/planner（用于快速筛选）',
    `extension_data` text COMMENT '扩展属性（JSON对象，存储服务类型特有字段）' CHECK (JSON_VALID(`extension_data`)),
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_provider_id` (`provider_id`),
    KEY `idx_service_type` (`service_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者扩展表（存储服务类型特有属性）';
```

**extension_data 字段说明**（JSON格式，按服务类型存储不同属性）:

**跟拍（photographer）扩展属性**:
```json
{
    "equipment": "佳能5D4、索尼A7R3、大疆无人机",
    "style_tags": "纪实、唯美、复古"
}
```

**管家（butler）扩展属性**:
```json
{
    "service_scope": "婚礼策划、现场执行、后期服务",
    "team_size": 5
}
```

**婚策（planner）扩展属性**（未来新增服务类型示例）:
```json
{
    "planning_style": "简约、浪漫、奢华",
    "case_count": 100,
    "certification": "国际婚礼策划师认证"
}
```

**查询优化**（使用生成列和虚拟索引）:
```sql
-- 为常用字段创建生成列和虚拟索引
ALTER TABLE `wedding_service_provider_extension`
ADD COLUMN `equipment` varchar(500) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(`extension_data`, '$.equipment'))) VIRTUAL COMMENT '设备清单（生成列）',
ADD COLUMN `team_size` int(10) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(`extension_data`, '$.team_size'))) VIRTUAL COMMENT '团队人数（生成列）',
ADD KEY `idx_equipment` (`equipment`),
ADD KEY `idx_team_size` (`team_size`);
```

**使用方式**:
- **写入**：将服务类型特有字段写入 `extension_data` JSON字段
- **读取**：直接读取 `extension_data` JSON字段，或使用生成列查询
- **查询**：使用生成列的虚拟索引进行高效查询
- **扩展**：新增服务类型时，只需在 `extension_data` 中添加新字段，无需修改表结构

### 2.4 服务提供者标签表 (wedding_service_provider_label)

**说明**: 
- **管理员标签系统**：标签只能由管理员创建和管理
- 标签按服务类型区分，`service_type`为空表示通用标签（所有服务类型可用）
- 管理员标签由管理员在编辑服务提供者时设置，存储在 `label_ids` 字段
- **自定义标签系统**：服务提供者可以自己设置擅长标签，存储在 `custom_labels` JSON字段
- 前端展示时合并管理员标签和自定义标签，统一展示

```sql
CREATE TABLE `wedding_service_provider_label` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `service_type` varchar(50) NOT NULL DEFAULT '' COMMENT '服务类型：host/photographer/butler（空=通用标签，所有服务类型可用）',
    `name` varchar(50) NOT NULL DEFAULT '' COMMENT '标签名称',
    `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '标签图标',
    `color` varchar(20) NOT NULL DEFAULT '' COMMENT '标签颜色',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者标签表（仅管理员可管理）';
```

### 2.5 服务提供者服务表 (wedding_service_provider_service)

```sql
CREATE TABLE `wedding_service_provider_service` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '类型：1=基础套餐，2=增值服务',
    `title` varchar(100) NOT NULL DEFAULT '' COMMENT '服务名称',
    `description` varchar(500) NOT NULL DEFAULT '' COMMENT '服务描述',
    `price` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT '价格（单位：元）',
    `period_prices` text COMMENT '场次价格配置（JSON）' CHECK (JSON_VALID(`period_prices`)),
    `available_periods` varchar(50) NOT NULL DEFAULT '' COMMENT '可用场次（逗号分隔）',
    `booking_mode` tinyint(1) NOT NULL DEFAULT 1 COMMENT '预定模式：1=分场次，2=全天',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_provider_id` (`provider_id`),
    KEY `idx_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者服务表';
```

**字段字典**:

| 字段名 | 字段类型 | 枚举值 | 业务含义 | 是否支持逻辑删除 | 禁止随意修改 |
|-------|---------|--------|---------|----------------|------------|
| type | tinyint(1) | 1=基础套餐，2=增值服务 | 服务类型 | ❌ | ❌ |
| booking_mode | tinyint(1) | 1=分场次，2=全天 | 预定模式 | ❌ | ✅（有订单关联后不可修改） |
| status | tinyint(1) | 0=禁用，1=正常 | 服务状态 | ❌ | ❌ |
| price | decimal(10,2) | - | 价格（单位：元） | ❌ | ✅（有订单关联后不可修改，需通过价格调整） |

**说明**:
- `price`和`booking_mode`在有订单关联后禁止修改，避免历史订单数据不一致
- 如需调整价格，通过档期的`price_adjust`字段实现

**period_prices 字段说明**（JSON格式）:
```json
{
    "1": 2000.00,   // 场次1（早场/早司仪）价格
    "2": 2500.00,   // 场次2（午场/午宴）价格
    "3": 3000.00   // 场次3（晚场/晚宴）价格
}
```

### 2.6 服务提供者档期表 (wedding_service_provider_schedule)

**数据生命周期策略**：
- 不支持逻辑删除
- 档期记录永久保留，用于历史追溯和数据分析
- 所有档期记录（空闲、休息、已预订）均保留，用于档期统计和历史查询

**说明**: 
- **档期模型设计（方案A：完全时间段模型）**：
  - **系统业务判断完全以 `start_time` + `end_time` 为准**
  - `period` 字段仅用于前端快速选择和展示，**不参与业务判断**
  - `period` 字段不入库或弱约束（允许为空，不参与唯一索引）
  - 不同服务类型可定义不同的默认档期模板（仅用于前端展示）
- **唯一索引**：`uk_provider_date_time` (provider_id, date, start_time, end_time)
  - 限制同一服务提供者同一天同一时间段只能有一条记录
  - 基于时间段重叠检测冲突
- **冲突检测规则**：
  - 基于时间段重叠判断：如果两个时间段有重叠，则冲突
  - 时间段重叠判断公式：`(start_time1 < end_time2) AND (end_time1 > start_time2)`
- **并发控制**：
  - 应用层：订单创建时检查时间段重叠
  - 数据库层：唯一索引防止并发冲突
  - 事务锁：使用 `SELECT ... FOR UPDATE` 锁定相关档期记录

```sql
CREATE TABLE `wedding_service_provider_schedule` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `date` date NOT NULL COMMENT '日期',
    `start_time` time NOT NULL COMMENT '服务开始时间（业务判断依据）',
    `end_time` time NOT NULL COMMENT '服务结束时间（业务判断依据）',
    `period_code` varchar(50) NOT NULL DEFAULT '' COMMENT '档期模板标识（可选，仅用于前端展示）',
    `period` tinyint(1) NOT NULL DEFAULT 0 COMMENT '场次类型（可选，仅用于前端快速选择和展示）：0=未设置，1=早场，2=午场，3=晚场，4=全天（不参与业务判断）',
    `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态：0=空闲，1=休息，2=已预订',
    `price_adjust` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '价格调整（单位：元）',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '关联订单ID',
    `remark` varchar(255) NOT NULL DEFAULT '' COMMENT '备注',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_provider_date_time` (`provider_id`, `date`, `start_time`, `end_time`),
    KEY `idx_date` (`date`),
    KEY `idx_status` (`status`),
    KEY `idx_provider_date` (`provider_id`, `date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者档期表（完全时间段模型）';
```

**字段说明**:
| 字段名 | 类型 | 说明 | 业务作用 |
|-------|------|------|---------|
| start_time | time | 服务开始时间 | ✅ **业务判断依据**（必填） |
| end_time | time | 服务结束时间 | ✅ **业务判断依据**（必填） |
| period_code | varchar(50) | 档期模板标识 | ❌ 仅用于前端展示（可选） |
| period | tinyint(1) | 场次类型 | ❌ **仅用于前端快速选择和展示，不参与业务判断**（可选，默认0） |

**重要说明**:
- **系统业务判断完全以 `start_time` + `end_time` 为准**
- `period` 字段仅用于前端快速选择和展示，**不参与业务判断**
- `period` 字段允许为空或0，不参与唯一索引
- 不同服务类型可定义不同的默认档期模板（仅用于前端展示）
- 档期冲突检测基于时间段重叠（start_time, end_time），不基于 period

**字段字典**:

| 字段名 | 字段类型 | 枚举值 | 业务含义 | 是否支持逻辑删除 | 禁止随意修改 | 历史追溯 |
|-------|---------|--------|---------|----------------|------------|---------|
| period | tinyint(1) | 1=早场，2=午场，3=晚场，4=全天 | 场次类型 | ❌ | ✅（创建后不可修改） | ❌ |
| status | tinyint(1) | 0=空闲，1=休息，2=已预订 | 档期状态 | ❌ | ❌（需通过业务方法修改） | ❌ |
| order_id | int(10) | - | 关联订单ID（status=2时必填） | ❌ | ❌（由订单创建/取消时自动更新） | ❌ |

**说明**:
- `start_time` 和 `end_time` 创建后禁止修改，如需修改需删除后重新创建
- `period` 字段可随意修改（仅用于前端展示，不参与业务判断）
- `status` 必须通过业务方法修改（不能直接UPDATE），确保数据一致性
- `order_id` 在订单创建时自动关联，订单取消/拒绝时自动清空
- 不支持逻辑删除，档期记录永久保留用于历史追溯
- **档期冲突检测规则**：
  - 基于时间段重叠判断：如果两个时间段有重叠，则冲突
  - 时间段重叠判断公式：`(start_time1 < end_time2) AND (end_time1 > start_time2)`
  - **数据库层**：唯一索引 `uk_provider_date_time (provider_id, date, start_time, end_time)` 防止并发冲突
  - **应用层**：订单创建时必须先检查时间段重叠，再使用事务锁（SELECT FOR UPDATE）锁定相关档期记录
  - **重要**：`period` 字段不参与唯一索引，如果同一天出现「09:00-11:00」和「10:00-12:00」两段，即使 period 都=1，唯一索引不会冲突，但时间段重叠，业务上属于「已被占用」，应用层必须检测并拒绝

### 2.7 服务提供者收藏表 (wedding_service_provider_favorite)

```sql
CREATE TABLE `wedding_service_provider_favorite` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_member_provider` (`member_id`, `provider_id`),
    KEY `idx_provider_id` (`provider_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务提供者收藏表';
```

---

## 三、订单相关表

### 3.1 预约订单表 (wedding_order)

**说明**: 订单表只保留 `provider_id`，服务类型通过关联 `wedding_service_provider` 表获取，避免数据冗余和不一致。

**数据生命周期策略**：
- 不支持逻辑删除
- 订单具有业务历史意义，终态订单永久保留用于历史追溯
- 所有订单记录（包括已取消、已拒绝）均保留，用于财务统计和业务分析
- 订单数据是系统的核心业务数据，必须永久保留

```sql
CREATE TABLE `wedding_order` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_no` varchar(32) NOT NULL DEFAULT '' COMMENT '订单编号',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID（通过关联获取service_type）',
    `reservation_date` date NOT NULL COMMENT '预约日期',
    
    -- 金额相关
    `total_amount` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '订单总额（单位：元）',
    `original_amount` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '原始订单金额（单位：元，用于改期时计算差价）',
    `change_date_fee` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '改期费（单位：元）',
    `price_difference` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '补差价（单位：元，正数=需补，负数=需退）',
    
    -- **金额字段精度说明**：
    -- 所有金额字段使用 decimal(12,4)，业务最大单量 999 999.9999，对于婚礼单够用
    -- 但退款时如果涉及「部分退 + 改期费 + 补差价」叠加，可能出现 0.0001 的精度误差累计
    -- **建议**：统一把金额计算封装到 Money 值对象，内部用 int（分）存储，避免浮点误差
    -- 等级：★☆ 可加固（非硬伤，但建议优化）
    
    -- 订单状态（拆状态设计）
    `order_status` smallint(4) NOT NULL DEFAULT 0 COMMENT '订单业务主状态（生命周期）：0=待审核，1=已同意，3=待服务，4=已完成，10=已拒绝，11=已取消，13=已关闭' CHECK (`order_status` >= 0 AND `order_status` <= 20),
    `payment_status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '支付状态：0=未付款，1=已付款，2=部分退款，3=已退款',
    `refund_status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '退款状态：0=无退款，1=退款申请中，2=退款已同意，3=退款已拒绝，4=退款已完成',
    `is_final_status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否终态：0=否，1=是（用于快速判断）',
    
    -- 联系信息
    `contact_name` varchar(50) NOT NULL DEFAULT '' COMMENT '联系人姓名',
    `contact_mobile` varchar(20) NOT NULL DEFAULT '' COMMENT '联系电话',
    `wedding_venue` varchar(255) NOT NULL DEFAULT '' COMMENT '婚礼场地',
    `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '用户备注',
    
    -- 审核相关
    `approve_time` int(11) NOT NULL DEFAULT 0 COMMENT '审核时间',
    `reject_reason` varchar(500) NOT NULL DEFAULT '' COMMENT '拒绝原因',
    
    -- 付款相关
    `user_payment_voucher` varchar(500) NOT NULL DEFAULT '' COMMENT '用户上传的付款凭证图片',
    `payment_voucher` varchar(500) NOT NULL DEFAULT '' COMMENT '管理员确认的付款凭证图片',
    `payment_amount` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT '实付金额',
    `payment_time` int(11) NOT NULL DEFAULT 0 COMMENT '付款确认时间',
    `payment_operator_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '付款确认人ID',
    `payment_remark` varchar(500) NOT NULL DEFAULT '' COMMENT '付款备注',
    
    -- 退款相关（管理员操作）
    `refund_voucher` varchar(500) NOT NULL DEFAULT '' COMMENT '退款凭证图片',
    `refund_amount` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '退款金额（单位：元）',
    -- **注意**：退款金额计算时需注意精度问题，建议使用 Money 值对象统一处理
    `refund_time` int(11) NOT NULL DEFAULT 0 COMMENT '退款确认时间',
    `refund_operator_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '退款确认人ID',
    `refund_remark` varchar(500) NOT NULL DEFAULT '' COMMENT '退款备注',
    
    -- 完成相关
    `complete_time` int(11) NOT NULL DEFAULT 0 COMMENT '完成时间',
    `cancel_time` int(11) NOT NULL DEFAULT 0 COMMENT '取消时间',
    `cancel_reason` varchar(500) NOT NULL DEFAULT '' COMMENT '取消原因',
    
    -- 改期相关
    `change_date_apply_time` int(11) NOT NULL DEFAULT 0 COMMENT '改期申请时间',
    `change_date_approve_time` int(11) NOT NULL DEFAULT 0 COMMENT '改期审核时间',
    `change_date_reject_time` int(11) NOT NULL DEFAULT 0 COMMENT '改期拒绝时间',
    `change_date_reject_reason` varchar(500) NOT NULL DEFAULT '' COMMENT '改期拒绝原因',
    `old_reservation_date` date DEFAULT NULL COMMENT '原预约日期（改期前）',
    `new_reservation_date` date DEFAULT NULL COMMENT '新预约日期（改期后）',
    `change_date_operator_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '改期操作人ID（管理员）',
    `change_date_remark` varchar(500) NOT NULL DEFAULT '' COMMENT '改期备注',
    
    -- 评价相关
    `is_reviewed` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否已评价：0=否，1=是',
    
    -- 快照数据
    `service_snapshot` text COMMENT '服务信息快照（JSON）',
    `service_snapshot_json` json GENERATED ALWAYS AS (JSON_EXTRACT(`service_snapshot`, '$')) VIRTUAL COMMENT '服务信息快照JSON生成列（用于索引）',
    
    -- 其他
    `is_manual` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否手动创建：0=否，1=是',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_order_no` (`order_no`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_provider_id` (`provider_id`),
    KEY `idx_order_status` (`order_status`),
    KEY `idx_reservation_date` (`reservation_date`),
    KEY `idx_create_time` (`create_time`),
    KEY `idx_service_snapshot_json` ((CAST(`service_snapshot_json`->'$.provider_id' AS UNSIGNED)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预约订单表';
```

**订单状态说明（拆状态设计）**:

**业务主状态（order_status）** - 订单生命周期状态：
| 状态值 | 状态名称 | 业务含义 | 是否终态 | 逻辑删除 | 历史追溯 |
|-------|---------|---------|---------|---------|---------|
| 0 | 待审核(CREATED) | 用户提交订单，等待服务提供者审核 | ❌ | ❌ | ✅（通过order_status_log表） |
| 1 | 已同意(CONFIRMED) | 服务提供者同意，等待付款 | ❌ | ❌ | ✅ |
| 3 | 待服务(SERVING) | 付款后等待服务 | ❌ | ❌ | ✅ |
| 4 | 已完成(FINISHED) | 服务完成 | ✅ | ❌ | ✅ |
| 10 | 已拒绝(REJECTED) | 服务提供者拒绝 | ✅ | ❌ | ✅ |
| 11 | 已取消(CANCELLED) | 用户取消 | ✅ | ❌ | ✅ |
| 13 | 已关闭(CLOSED) | 管理员强制关闭 | ✅ | ❌ | ✅ |

**支付状态（payment_status）** - 财务状态：
| 状态值 | 状态名称 | 业务含义 | 说明 |
|-------|---------|---------|------|
| 0 | 未付款(UNPAID) | 订单未付款 | 默认状态 |
| 1 | 已付款(PAID) | 订单已付款 | 管理员确认付款后 |
| 2 | 部分退款(PARTIAL_REFUND) | 订单部分退款 | 部分退款完成后 |
| 3 | 已退款(FULL_REFUND) | 订单已退款 | 全额退款完成后 |

**退款状态（refund_status）** - 退款流程状态：
| 状态值 | 状态名称 | 业务含义 | 说明 |
|-------|---------|---------|------|
| 0 | 无退款(NONE) | 无退款申请 | 默认状态 |
| 1 | 退款申请中(APPLY) | 用户申请退款 | 用户提交退款申请 |
| 2 | 退款已同意(APPROVED) | 管理员同意退款 | 管理员审核通过 |
| 3 | 退款已拒绝(REJECTED) | 管理员拒绝退款 | 管理员审核拒绝 |
| 4 | 退款已完成(COMPLETED) | 退款已完成 | 退款流程完成 |

**状态组合规则**：
- 订单完整状态由 `order_status` + `payment_status` + `refund_status` 共同决定
- 合法状态组合示例：
  - `order_status=CONFIRMED(1)` + `payment_status=UNPAID(0)` + `refund_status=NONE(0)` = 已同意，待付款
  - `order_status=SERVING(3)` + `payment_status=PAID(1)` + `refund_status=NONE(0)` = 待服务，已付款
  - `order_status=SERVING(3)` + `payment_status=PAID(1)` + `refund_status=APPLY(1)` = 待服务，已付款，退款申请中
  - `order_status=SERVING(3)` + `payment_status=PARTIAL_REFUND(2)` + `refund_status=COMPLETED(4)` = 待服务，部分退款已完成
- 详细状态组合规则见《00-系统设计总纲.md》状态机定义章节

**状态值设计说明**:
- `order_status`：业务主状态，表示订单生命周期
- `payment_status`：支付状态，独立管理财务流程
- `refund_status`：退款状态，独立管理退款流程
- 三个状态字段组合使用，避免单一字段过载
- `order_status` 字段类型为 `smallint(4)`，支持更多状态值

**字段约束说明**:
- **禁止随意修改字段**: 
  - `order_no`: 订单编号，创建后不可修改
  - `order_status`: 必须通过状态流转方法修改，禁止直接UPDATE
  - `payment_status`: 必须通过状态流转方法修改，禁止直接UPDATE
  - `refund_status`: 必须通过状态流转方法修改，禁止直接UPDATE
  - `total_amount`: 创建后不可修改（如需修改需取消后重新创建）
  - `create_time`: 创建时间，禁止修改
- **支持逻辑删除**: 订单表不支持逻辑删除，终态订单永久保留用于历史追溯
- **历史状态追溯**: 通过 `wedding_order_status_log` 表记录所有状态变更历史
- **状态组合约束**: `order_status`、`payment_status`、`refund_status` 的组合必须符合业务规则（见状态机定义）

**订单状态流转图（拆状态设计）**:

**业务主状态流转**：
```
用户提交订单
    ↓
待审核(CREATED=0) ─────────────────────────────┐
    │                                          │
    │ [服务提供者同意]           [服务提供者拒绝]│
    ↓                                          ↓
已同意(CONFIRMED=1) ─────────────────────→ 已拒绝(REJECTED=10)
    │                                          │
    │ [管理员确认付款]                          │
    │ payment_status: UNPAID(0) → PAID(1)     │
    │                                          │
    ↓ [自动流转]                                │
待服务(SERVING=3) ─────────────────────────┐   │
    │                                      │   │
    │ [服务完成]              [用户申请退款]│   │
    │                        refund_status:│   │
    │                        NONE(0)→APPLY(1)│
    ↓                                      │   │
已完成(FINISHED=4)                        │   │
    │                                      │   │
    │                                      │   │
    └──────────────────────────────────────┘   │
                                                │
任意状态 ─→ [用户取消] ─→ 已取消(CANCELLED=11) ──┘

任意状态 ─→ [管理员强制关闭] ─→ 已关闭(CLOSED=13)（终态）
```

**支付状态流转**：
```
UNPAID(0) ──[管理员确认付款]──→ PAID(1)
    │                              │
    │                              │ [部分退款]
    │                              ↓
    │                        PARTIAL_REFUND(2)
    │                              │
    │                              │ [全额退款]
    │                              ↓
    └──────────────────────── FULL_REFUND(3)
```

**退款状态流转**：
```
NONE(0) ──[用户申请退款]──→ APPLY(1)
                              │
                    ┌─────────┴─────────┐
                    │                   │
        [管理员同意] │                   │ [管理员拒绝]
                    ↓                   ↓
            APPROVED(2)          REJECTED(3)
                    │
        [管理员确认退款完成]
                    ↓
            COMPLETED(4)
```

**状态机矩阵表（详细定义见《00-系统设计总纲.md》和《11-状态机定义文档.md》）**:

**业务主状态（order_status）迁移**：
| FROM | TO | ALLOWED_ROLE | API | 前置条件 |
|------|----|--------------|-----|---------|
| CREATED(0) | CONFIRMED(1) | provider | POST /api/v1/order/approve | order_status=0, payment_status=0 |
| CREATED(0) | REJECTED(10) | provider | POST /api/v1/order/reject | order_status=0 |
| CREATED(0) | CANCELLED(11) | user | POST /api/v1/order/cancel | order_status=0 |
| CREATED(0) | CLOSED(13) | admin | POST /admin/order/close | order_status=0 |
| CONFIRMED(1) | SERVING(3) | system | 自动流转 | order_status=1, payment_status=1 |
| CONFIRMED(1) | CANCELLED(11) | user | POST /api/v1/order/cancel | order_status=1 |
| CONFIRMED(1) | CLOSED(13) | admin | POST /admin/order/close | order_status=1 |
| SERVING(3) | FINISHED(4) | provider | POST /api/v1/order/complete | order_status=3 |
| SERVING(3) | CLOSED(13) | admin | POST /admin/order/close | order_status=3 |
| FINISHED(4) | - | - | 终态，不可再流转 | - |
| REJECTED(10) | - | - | 终态，不可再流转 | - |
| CANCELLED(11) | - | - | 终态，不可再流转 | - |
| CLOSED(13) | - | - | 终态，不可再流转 | - |

**支付状态（payment_status）迁移**：
| FROM | TO | ALLOWED_ROLE | API | 前置条件 |
|------|----|--------------|-----|---------|
| UNPAID(0) | PAID(1) | admin | POST /admin/order/confirmPayment | order_status=CONFIRMED(1) |
| PAID(1) | PARTIAL_REFUND(2) | admin | POST /admin/order/confirmRefund | refund_status=APPROVED(2) |
| PAID(1) | FULL_REFUND(3) | admin | POST /admin/order/confirmRefund | refund_status=COMPLETED(4) |

**退款状态（refund_status）迁移**：
| FROM | TO | ALLOWED_ROLE | API | 前置条件 |
|------|----|--------------|-----|---------|
| NONE(0) | APPLY(1) | user | POST /api/v1/order/refund | order_status=SERVING(3) |
| APPLY(1) | APPROVED(2) | admin | POST /admin/order/auditRefund | refund_status=APPLY(1) |
| APPLY(1) | REJECTED(3) | admin | POST /admin/order/auditRefund | refund_status=APPLY(1) |
| APPROVED(2) | COMPLETED(4) | admin | POST /admin/order/confirmRefund | refund_status=APPROVED(2) |

### 3.2 订单场次明细表 (wedding_order_period)

```sql
CREATE TABLE `wedding_order_period` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `period` tinyint(1) NOT NULL DEFAULT 1 COMMENT '场次：1=早场（早司仪），2=午场（午宴），3=晚场（晚宴）（所有服务类型统一）',
    `package_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '套餐ID',
    `package_title` varchar(100) NOT NULL DEFAULT '' COMMENT '套餐名称（快照）',
    `package_price` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '套餐价格（快照，单位：元）',
    `price_adjust` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '档期价格调整（单位：元）',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单场次明细表';
```

### 3.3 订单增值服务表 (wedding_order_option)

```sql
CREATE TABLE `wedding_order_option` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `service_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务ID',
    `service_title` varchar(100) NOT NULL DEFAULT '' COMMENT '服务名称（快照）',
    `service_price` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '服务单价（快照，单位：元）',
    `apply_periods` varchar(50) NOT NULL DEFAULT '' COMMENT '应用场次（逗号分隔）',
    `period_count` int(10) NOT NULL DEFAULT 1 COMMENT '场次数量',
    `total_price` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '小计金额（单位：元）',
    `is_refunded` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否已退款：0=否，1=是（部分退款时使用）',
    `refund_amount` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '退款金额（单位：元）',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单增值服务表';
```

### 3.4 订单状态日志表 (wedding_order_status_log)

**说明**: 
- 日志表数据量大，一年后可能达到千万级，使用分区表优化查询性能
- 按月份分区（RANGE分区），分区键使用 `create_time`
- 主键包含分区键，确保分区裁剪生效

**数据生命周期策略**：
- 不支持逻辑删除
- 状态变更历史永久保留，用于订单状态追溯和审计
- 使用分区表管理，建议保留12-24个月数据，过期数据可归档
- 所有状态变更记录必须保留，用于业务分析和问题排查

```sql
CREATE TABLE `wedding_order_status_log` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `order_no` varchar(32) NOT NULL DEFAULT '' COMMENT '订单编号',
    `from_status` smallint(4) NOT NULL DEFAULT 0 COMMENT '原状态',
    `to_status` smallint(4) NOT NULL DEFAULT 0 COMMENT '新状态',
    `operator_type` tinyint(1) NOT NULL DEFAULT 0 COMMENT '操作人类型：0=系统，1=管理员，2=会员，3=服务提供者',
    `operator_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '操作人ID',
    `operator_name` varchar(50) NOT NULL DEFAULT '' COMMENT '操作人名称',
    `reason` varchar(500) NOT NULL DEFAULT '' COMMENT '变更原因',
    `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`, `create_time`),
    KEY `idx_order_id` (`order_id`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单状态日志表'
PARTITION BY RANGE (`create_time`) (
    PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (UNIX_TIMESTAMP('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01')),
    PARTITION p202504 VALUES LESS THAN (UNIX_TIMESTAMP('2025-05-01')),
    PARTITION p202505 VALUES LESS THAN (UNIX_TIMESTAMP('2025-06-01')),
    PARTITION p202506 VALUES LESS THAN (UNIX_TIMESTAMP('2025-07-01')),
    PARTITION p202507 VALUES LESS THAN (UNIX_TIMESTAMP('2025-08-01')),
    PARTITION p202508 VALUES LESS THAN (UNIX_TIMESTAMP('2025-09-01')),
    PARTITION p202509 VALUES LESS THAN (UNIX_TIMESTAMP('2025-10-01')),
    PARTITION p202510 VALUES LESS THAN (UNIX_TIMESTAMP('2025-11-01')),
    PARTITION p202511 VALUES LESS THAN (UNIX_TIMESTAMP('2025-12-01')),
    PARTITION p202512 VALUES LESS THAN (UNIX_TIMESTAMP('2026-01-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

**分区管理**:
- **添加新分区**：每月初执行，添加下个月的分区
- **删除旧分区**：根据数据保留策略（如保留12个月），删除过期分区
- **分区裁剪**：查询时指定 `create_time` 范围，MySQL自动裁剪到相关分区

**分区管理SQL示例**:
```sql
-- 添加下个月分区（每月1号执行）
ALTER TABLE wedding_order_status_log 
REORGANIZE PARTITION p_future INTO (
    PARTITION p202601 VALUES LESS THAN (UNIX_TIMESTAMP('2026-02-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 删除12个月前的分区（数据保留12个月）
ALTER TABLE wedding_order_status_log DROP PARTITION p202501;
```

---

## 四、评价与退款表

### 4.1 评价表 (wedding_review)

**数据生命周期策略**：
- 不支持逻辑删除
- 评价记录永久保留，用于服务提供者评分统计和历史查询
- 所有评价记录（包括已隐藏）均保留，用于数据分析和问题排查

```sql
CREATE TABLE `wedding_review` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `service_type` varchar(50) NOT NULL DEFAULT 'host' COMMENT '服务类型：host/photographer/butler',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `score` tinyint(1) NOT NULL DEFAULT 5 COMMENT '评分（1-5）',
    `content` text COMMENT '评价内容',
    `images` text COMMENT '评价图片（JSON数组）',
    `images_json` json GENERATED ALWAYS AS (JSON_EXTRACT(`images`, '$')) VIRTUAL COMMENT '评价图片JSON生成列（用于索引）',
    `reply_content` text COMMENT '服务提供者回复',
    `reply_time` int(11) NOT NULL DEFAULT 0 COMMENT '回复时间',
    `is_anonymous` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否匿名：0=否，1=是',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=待审核，1=显示，2=隐藏',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_provider_id` (`provider_id`),
    KEY `idx_order_id` (`order_id`),
    KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

### 4.2 退款申请表 (wedding_refund_apply)

**说明**: 支持整单退款和部分退款（按场次、增值服务指定退款）

**数据生命周期策略**：
- 不支持逻辑删除
- 退款申请记录永久保留，用于财务追溯和业务分析
- 所有退款申请记录（包括已拒绝）均保留，用于财务审计

```sql
CREATE TABLE `wedding_refund_apply` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `refund_no` varchar(32) NOT NULL DEFAULT '' COMMENT '退款单号',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `order_no` varchar(32) NOT NULL DEFAULT '' COMMENT '订单编号',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `client_request_id` varchar(64) NOT NULL DEFAULT '' COMMENT '客户端请求ID（幂等键）',
    `refund_type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '退款类型：1=整单退款，2=部分退款',
    `refund_amount` decimal(12,4) NOT NULL DEFAULT 0.0000 COMMENT '申请退款金额（单位：元，自动计算）',
    `refund_items` text COMMENT '退款明细（JSON数组，部分退款时使用）' CHECK (JSON_VALID(`refund_items`)),
    `refund_reason` varchar(500) NOT NULL DEFAULT '' COMMENT '退款原因',
    `apply_type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '申请类型：1=用户申请，2=管理员操作',
    `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态：0=待审核，1=已同意，2=已拒绝，3=已完成',
    `audit_time` int(11) NOT NULL DEFAULT 0 COMMENT '审核时间',
    `audit_remark` varchar(500) NOT NULL DEFAULT '' COMMENT '审核备注',
    `complete_time` int(11) NOT NULL DEFAULT 0 COMMENT '完成时间',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_refund_no` (`refund_no`),
    UNIQUE KEY `uk_member_client_request_id` (`member_id`, `client_request_id`),
    KEY `idx_order_id` (`order_id`),
    KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='退款申请表';
```

**refund_items 字段说明**（JSON格式，部分退款时使用）:
```json
[
    {
        "type": "period",
        "period_id": 1,
        "period": 2,
        "period_name": "午场",
        "package_price": 2500.00,
        "price_adjust": 0.00,
        "refund_amount": 2500.00
    },
    {
        "type": "addon",
        "addon_id": 2,
        "service_id": 2,
        "service_title": "现场彩排",
        "service_price": 500.00,
        "period_count": 2,
        "total_price": 1000.00,
        "refund_amount": 1000.00
    }
]
```

**字段说明**:
- `refund_type`: 1=整单退款，2=部分退款
- `refund_amount`: 退款金额，部分退款时根据 `refund_items` 自动计算
- `refund_items`: 退款明细（JSON数组），仅部分退款时使用
  - `type`: "period"（场次）或 "addon"（增值服务）
  - `period_id`: 订单场次明细ID（type=period时）
  - `addon_id`: 订单增值服务ID（type=addon时）
  - `refund_amount`: 该项的退款金额

---

## 五、动态相关表

### 5.1 动态表 (wedding_dynamic)

**数据生命周期策略**：
- 支持逻辑删除（is_deleted字段）
- 逻辑删除后数据保留，但不再展示
- 删除后数据可用于统计和历史查询
- 无强业务历史意义，但保留用于数据分析

```sql
CREATE TABLE `wedding_dynamic` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `service_type` varchar(50) NOT NULL DEFAULT 'host' COMMENT '服务类型：host/photographer/butler',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID',
    `category_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '分类ID',
    `type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '类型：1=图文，2=视频',
    `content` text COMMENT '动态内容',
    `images` text COMMENT '图片列表（JSON数组）',
    `video` varchar(500) NOT NULL DEFAULT '' COMMENT '视频地址',
    `video_cover` varchar(500) NOT NULL DEFAULT '' COMMENT '视频封面',
    `video_duration` int(10) NOT NULL DEFAULT 0 COMMENT '视频时长（秒）',
    `view_count` int(10) NOT NULL DEFAULT 0 COMMENT '浏览量',
    `like_count` int(10) NOT NULL DEFAULT 0 COMMENT '点赞数',
    `comment_count` int(10) NOT NULL DEFAULT 0 COMMENT '评论数',
    `share_count` int(10) NOT NULL DEFAULT 0 COMMENT '分享数',
    `is_top` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否置顶：0=否，1=是',
    `top_time` int(11) NOT NULL DEFAULT 0 COMMENT '置顶时间',
    `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态：0=待审核，1=已发布，2=已拒绝，3=已下架',
    `reject_reason` varchar(500) NOT NULL DEFAULT '' COMMENT '拒绝原因',
    `audit_time` int(11) NOT NULL DEFAULT 0 COMMENT '审核时间',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0=否，1=是（用于快速查询）',
    `deleted_at` int(11) NOT NULL DEFAULT 0 COMMENT '删除时间（时间戳，用于追溯删除时间）',
    PRIMARY KEY (`id`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_provider_id` (`provider_id`),
    KEY `idx_category_id` (`category_id`),
    KEY `idx_status` (`status`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='动态表';
```

### 5.2 动态分类表 (wedding_dynamic_category)

```sql
CREATE TABLE `wedding_dynamic_category` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `name` varchar(50) NOT NULL DEFAULT '' COMMENT '分类名称',
    `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '分类图标',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='动态分类表';
```

### 5.3 动态评论表 (wedding_dynamic_comment)

```sql
CREATE TABLE `wedding_dynamic_comment` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `dynamic_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '动态ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '评论人ID',
    `parent_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '父评论ID（0=一级评论）',
    `reply_to_member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '回复的用户ID',
    `content` text COMMENT '评论内容',
    `like_count` int(10) NOT NULL DEFAULT 0 COMMENT '点赞数',
    `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态：0=待审核，1=已发布，2=已拒绝',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0=否，1=是',
    PRIMARY KEY (`id`),
    KEY `idx_dynamic_id` (`dynamic_id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='动态评论表';
```

### 5.4 动态点赞表 (wedding_dynamic_like)

```sql
CREATE TABLE `wedding_dynamic_like` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `dynamic_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '动态ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_dynamic_member` (`dynamic_id`, `member_id`),
    KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='动态点赞表';
```

---

## 六、用户与系统表

### 6.1 会员表 (wedding_member)

**数据生命周期策略**：
- 支持逻辑删除（is_deleted字段）
- 逻辑删除后数据保留，但不再参与查询
- openid唯一索引，逻辑删除后仍保持唯一性
- 删除后不影响历史订单数据（订单通过member_id关联）

```sql
CREATE TABLE `wedding_member` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `openid` varchar(64) NOT NULL DEFAULT '' COMMENT '微信OpenID',
    `unionid` varchar(64) NOT NULL DEFAULT '' COMMENT '微信UnionID',
    `nickname` varchar(50) NOT NULL DEFAULT '' COMMENT '昵称',
    `avatar` varchar(500) NOT NULL DEFAULT '' COMMENT '头像',
    `mobile` varchar(20) NOT NULL DEFAULT '' COMMENT '手机号',
    `sex` tinyint(1) NOT NULL DEFAULT 0 COMMENT '性别：0=未知，1=男，2=女',
    `is_provider` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否服务提供者：0=否，1=是',
    `service_type` varchar(50) NOT NULL DEFAULT '' COMMENT '服务类型：host/photographer/butler',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '关联服务提供者ID',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    `last_login_time` int(11) NOT NULL DEFAULT 0 COMMENT '最后登录时间',
    `last_login_ip` varchar(50) NOT NULL DEFAULT '' COMMENT '最后登录IP',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_openid` (`openid`),
    KEY `idx_mobile` (`mobile`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_provider_id` (`provider_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员表';
```

### 6.2 管理员表 (wedding_admin)

**说明**: 增强登录安全，防止撞库攻击

**数据生命周期策略**：
- 支持逻辑删除（is_deleted字段）
- 逻辑删除后数据保留，但不再参与查询
- username唯一索引，逻辑删除后仍保持唯一性
- 删除后不影响历史操作日志（日志通过admin_id关联）

```sql
CREATE TABLE `wedding_admin` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `username` varchar(50) NOT NULL DEFAULT '' COMMENT '用户名',
    `password` varchar(255) NOT NULL DEFAULT '' COMMENT '密码（bcrypt加密）',
    `realname` varchar(50) NOT NULL DEFAULT '' COMMENT '真实姓名',
    `mobile` varchar(20) NOT NULL DEFAULT '' COMMENT '手机号',
    `avatar` varchar(500) NOT NULL DEFAULT '' COMMENT '头像',
    `role` varchar(50) NOT NULL DEFAULT 'admin' COMMENT '角色',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=正常',
    
    -- 登录安全相关
    `login_fail_count` int(10) NOT NULL DEFAULT 0 COMMENT '登录失败次数',
    `login_lock_time` int(11) NOT NULL DEFAULT 0 COMMENT '登录锁定时间（时间戳，0=未锁定）',
    `last_login_time` int(11) NOT NULL DEFAULT 0 COMMENT '最后登录时间',
    `last_login_ip` varchar(50) NOT NULL DEFAULT '' COMMENT '最后登录IP',
    
    -- 2FA双因素认证（可选）
    `two_factor_enabled` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否启用2FA：0=否，1=是',
    `two_factor_secret` varchar(255) NOT NULL DEFAULT '' COMMENT '2FA密钥（加密存储）',
    `two_factor_backup_codes` text COMMENT '2FA备用码（JSON数组，加密存储）' CHECK (JSON_VALID(`two_factor_backup_codes`)),
    
    -- IP白名单（可选）
    `ip_whitelist` text COMMENT 'IP白名单（JSON数组，空=不限制）' CHECK (JSON_VALID(`ip_whitelist`)),
    
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0=否，1=是',
    `deleted_at` int(11) NOT NULL DEFAULT 0 COMMENT '删除时间（时间戳）',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员表';
```

**登录安全机制**:
- **登录失败次数限制**：5次失败后锁定30分钟
- **IP白名单**：可选，限制登录IP范围
- **2FA双因素认证**：可选，使用TOTP（Time-based One-Time Password）
- **登录日志**：记录所有登录尝试（成功/失败）

### 6.2.1 管理员登录日志表 (wedding_admin_login_log)

**说明**: 记录管理员登录尝试，用于安全审计和异常检测

```sql
CREATE TABLE `wedding_admin_login_log` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `admin_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '管理员ID（0=用户名不存在）',
    `username` varchar(50) NOT NULL DEFAULT '' COMMENT '登录用户名',
    `login_ip` varchar(50) NOT NULL DEFAULT '' COMMENT '登录IP',
    `user_agent` varchar(500) NOT NULL DEFAULT '' COMMENT 'User-Agent',
    `login_result` tinyint(1) NOT NULL DEFAULT 0 COMMENT '登录结果：0=失败，1=成功',
    `fail_reason` varchar(255) NOT NULL DEFAULT '' COMMENT '失败原因：wrong_password/account_locked/ip_not_allowed/2fa_failed',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_admin_id` (`admin_id`),
    KEY `idx_username` (`username`),
    KEY `idx_login_ip` (`login_ip`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员登录日志表';
```

### 6.3 系统配置表 (wedding_config)

```sql
CREATE TABLE `wedding_config` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `key` varchar(100) NOT NULL DEFAULT '' COMMENT '配置键',
    `value` text COMMENT '配置值',
    `description` varchar(255) NOT NULL DEFAULT '' COMMENT '配置说明',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

**微信订阅消息模板配置**:
- 配置键：`subscribe_message_templates`
- 配置值示例（JSON格式）:
```json
{
    "order_status": {
        "template_id": "xxx",
        "title": "订单状态更新",
        "description": "订单状态变更通知"
    },
    "order_timeout": {
        "template_id": "xxx",
        "title": "订单超时提醒",
        "description": "订单即将超时提醒"
    },
    "review_reply": {
        "template_id": "xxx",
        "title": "评价回复通知",
        "description": "收到评价回复通知"
    }
}
```

### 6.4 DIY组件注册表 (wedding_diy_component)

**说明**: 
- **设计目的**：解决DIY组件硬编码问题，支持动态注册新组件
- **插件化设计**：前后端通过组件注册表加载组件，无需修改硬代码
- **组件分类**：支持按分类组织组件，便于管理
- **配置项定义**：使用JSON字段定义组件的配置项结构

```sql
CREATE TABLE `wedding_diy_component` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `component_name` varchar(100) NOT NULL DEFAULT '' COMMENT '组件名称（唯一，如：ProviderMediaCarousel）',
    `component_title` varchar(100) NOT NULL DEFAULT '' COMMENT '组件标题（显示名称，如：媒体轮播）',
    `category` varchar(50) NOT NULL DEFAULT 'basic' COMMENT '组件分类：basic=基础组件，media=媒体组件，info=信息组件，interaction=交互组件',
    `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '组件图标（图标字体类名或图片URL）',
    `description` varchar(500) NOT NULL DEFAULT '' COMMENT '组件描述',
    `page_type` varchar(50) NOT NULL DEFAULT '' COMMENT '适用页面类型：PROVIDER_DETAIL=服务提供者详情页（空=通用）',
    `config_schema` text COMMENT '配置项结构（JSON Schema格式，定义组件的配置项）' CHECK (JSON_VALID(`config_schema`)),
    `default_value` text COMMENT '默认配置值（JSON对象，组件的默认配置）' CHECK (JSON_VALID(`default_value`)),
    `preview_image` varchar(500) NOT NULL DEFAULT '' COMMENT '预览图',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=启用',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_component_name` (`component_name`),
    KEY `idx_category` (`category`),
    KEY `idx_page_type` (`page_type`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='DIY组件注册表（支持动态注册新组件）';
```

**config_schema 字段说明**（JSON Schema格式，定义组件的配置项结构）:
```json
{
    "type": "object",
    "properties": {
        "height": {
            "type": "number",
            "title": "高度",
            "default": 640,
            "min": 100,
            "max": 2000
        },
        "autoplay": {
            "type": "boolean",
            "title": "自动播放",
            "default": true
        },
        "interval": {
            "type": "number",
            "title": "播放间隔（秒）",
            "default": 5,
            "min": 1,
            "max": 60
        },
        "list": {
            "type": "array",
            "title": "媒体列表",
            "items": {
                "type": "object",
                "properties": {
                    "type": {
                        "type": "string",
                        "title": "类型",
                        "enum": ["image", "video"]
                    },
                    "url": {
                        "type": "string",
                        "title": "URL"
                    }
                }
            }
        }
    }
}
```

**default_value 字段说明**（JSON对象，组件的默认配置）:
```json
{
    "height": 640,
    "autoplay": true,
    "interval": 5,
    "list": []
}
```

**使用方式**:
- **注册组件**：管理员在后台添加组件记录，定义组件名称、配置项结构等
- **前端加载**：前端通过API获取组件列表，动态加载组件
- **配置渲染**：根据 `config_schema` 动态生成配置表单
- **数据存储**：组件配置存储在 `wedding_diy_page.value` 中

### 6.5 DIY页面表 (wedding_diy_page)

```sql
CREATE TABLE `wedding_diy_page` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `title` varchar(100) NOT NULL DEFAULT '' COMMENT '页面标题',
    `name` varchar(100) NOT NULL DEFAULT '' COMMENT '页面标识（唯一）',
    `type` varchar(50) NOT NULL DEFAULT 'PROVIDER_DETAIL' COMMENT '页面类型：PROVIDER_DETAIL=服务提供者详情页',
    `mode` varchar(20) NOT NULL DEFAULT 'diy' COMMENT '页面模式：diy=自定义，fixed=固定',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '关联服务提供者ID（PROVIDER_DETAIL类型时）',
    `value` longtext COMMENT '页面数据（JSON格式，包含组件配置）',
    `cover` varchar(500) NOT NULL DEFAULT '' COMMENT '页面封面图',
    `preview` varchar(500) NOT NULL DEFAULT '' COMMENT '页面预览图',
    `is_default` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否默认模板：0=否，1=是',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=启用',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`),
    KEY `idx_provider_id` (`provider_id`),
    KEY `idx_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='DIY页面表';
```

**value字段说明**（JSON格式）:
```json
{
    "global": {
        "title": "服务提供者详情",
        "pageStartBgColor": "#F8F8F8",
        "pageEndBgColor": "",
        "pageGradientAngle": "to bottom",
        "bgUrl": ""
    },
    "value": [
        {
            "id": "unique_id",
            "componentName": "ProviderMediaCarousel",
            "componentTitle": "媒体轮播",
            "value": {
                // 组件配置数据
            },
            "template": {
                // 组件样式配置
            }
        }
    ]
}
```

**预置配置项**:

| key | 说明 | 示例值 |
|-----|------|-------|
| basic_config | 基础配置 | {"site_name": "婚庆管家"} |
| order_config | 订单配置 | {"auto_cancel_hours": 24, "timeout_reject_hours": 48} |
| review_config | 评价配置 | {"need_audit": true} |
| dynamic_config | 动态配置 | {"need_audit": true} |
| message_config | 消息配置 | {"enable_notify": true} |

---

## 七、消息与内容管理表

### 7.1 消息表 (wedding_message)

```sql
CREATE TABLE `wedding_message` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '接收会员ID（0=全体用户）',
    `type` varchar(50) NOT NULL DEFAULT '' COMMENT '消息类型：order_status/order_timeout/review_reply/system_notice',
    `title` varchar(255) NOT NULL DEFAULT '' COMMENT '消息标题',
    `content` text COMMENT '消息内容',
    `link_type` varchar(50) NOT NULL DEFAULT '' COMMENT '链接类型：order/dynamic/host/none',
    `link_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '链接ID',
    `link_url` varchar(500) NOT NULL DEFAULT '' COMMENT '链接地址',
    `is_read` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否已读：0=否，1=是（针对全体消息）',
    `read_count` int(10) NOT NULL DEFAULT 0 COMMENT '已读人数（针对全体消息）',
    `send_time` int(11) NOT NULL DEFAULT 0 COMMENT '发送时间',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_type` (`type`),
    KEY `idx_send_time` (`send_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

### 7.2 消息已读记录表 (wedding_message_read)

```sql
CREATE TABLE `wedding_message_read` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `message_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '消息ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '会员ID',
    `read_time` int(11) NOT NULL DEFAULT 0 COMMENT '阅读时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_message_member` (`message_id`, `member_id`),
    KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息已读记录表';
```

### 7.3 公告表 (wedding_notice)

```sql
CREATE TABLE `wedding_notice` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `title` varchar(255) NOT NULL DEFAULT '' COMMENT '公告标题',
    `content` text COMMENT '公告内容',
    `cover` varchar(500) NOT NULL DEFAULT '' COMMENT '封面图',
    `link_type` varchar(50) NOT NULL DEFAULT '' COMMENT '链接类型：url/none',
    `link_url` varchar(500) NOT NULL DEFAULT '' COMMENT '链接地址',
    `target_type` tinyint(1) NOT NULL DEFAULT 0 COMMENT '目标用户：0=所有用户，1=普通用户，2=主持人',
    `is_top` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否置顶：0=否，1=是',
    `top_time` int(11) NOT NULL DEFAULT 0 COMMENT '置顶时间',
    `view_count` int(10) NOT NULL DEFAULT 0 COMMENT '查看次数',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=启用',
    `publish_time` int(11) NOT NULL DEFAULT 0 COMMENT '发布时间',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_status` (`status`),
    KEY `idx_publish_time` (`publish_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='公告表';
```

### 7.4 轮播图表 (wedding_banner)

```sql
CREATE TABLE `wedding_banner` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `title` varchar(255) NOT NULL DEFAULT '' COMMENT '标题',
    `image` varchar(500) NOT NULL DEFAULT '' COMMENT '图片地址',
    `link_type` varchar(50) NOT NULL DEFAULT '' COMMENT '链接类型：url/host/dynamic/none',
    `link_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '链接ID',
    `link_url` varchar(500) NOT NULL DEFAULT '' COMMENT '链接地址',
    `position` varchar(50) NOT NULL DEFAULT 'home' COMMENT '位置：home/index/provider_detail',
    `sort` int(10) NOT NULL DEFAULT 0 COMMENT '排序',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0=禁用，1=启用',
    `start_time` int(11) NOT NULL DEFAULT 0 COMMENT '开始时间',
    `end_time` int(11) NOT NULL DEFAULT 0 COMMENT '结束时间',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_position` (`position`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='轮播图表';
```

### 7.5 分享记录表 (wedding_share_log)

```sql
CREATE TABLE `wedding_share_log` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `member_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '分享人ID',
    `share_type` varchar(50) NOT NULL DEFAULT '' COMMENT '分享类型：host/dynamic/order',
    `share_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '分享对象ID',
    `share_channel` varchar(50) NOT NULL DEFAULT '' COMMENT '分享渠道：wechat/friend/moments',
    `share_count` int(10) NOT NULL DEFAULT 1 COMMENT '分享次数',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_share_type` (`share_type`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分享记录表';
```

### 7.6 订单超时日志表 (wedding_order_timeout_log)

**说明**: 
- 日志表数据量大，一年后可能达到千万级，使用分区表优化查询性能
- 按月份分区（RANGE分区），分区键使用 `create_time`
- 主键包含分区键，确保分区裁剪生效

```sql
CREATE TABLE `wedding_order_timeout_log` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `order_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '订单ID',
    `order_no` varchar(32) NOT NULL DEFAULT '' COMMENT '订单编号',
    `timeout_type` varchar(50) NOT NULL DEFAULT '' COMMENT '超时类型：pending_timeout/payment_timeout',
    `timeout_hours` int(10) NOT NULL DEFAULT 0 COMMENT '超时小时数',
    `old_status` smallint(4) NOT NULL DEFAULT 0 COMMENT '原状态',
    `new_status` smallint(4) NOT NULL DEFAULT 0 COMMENT '新状态',
    `action` varchar(50) NOT NULL DEFAULT '' COMMENT '处理动作：auto_reject/auto_cancel/notify',
    `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    PRIMARY KEY (`id`, `create_time`),
    KEY `idx_order_id` (`order_id`),
    KEY `idx_timeout_type` (`timeout_type`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单超时日志表'
PARTITION BY RANGE (`create_time`) (
    PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (UNIX_TIMESTAMP('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01')),
    PARTITION p202504 VALUES LESS THAN (UNIX_TIMESTAMP('2025-05-01')),
    PARTITION p202505 VALUES LESS THAN (UNIX_TIMESTAMP('2025-06-01')),
    PARTITION p202506 VALUES LESS THAN (UNIX_TIMESTAMP('2025-07-01')),
    PARTITION p202507 VALUES LESS THAN (UNIX_TIMESTAMP('2025-08-01')),
    PARTITION p202508 VALUES LESS THAN (UNIX_TIMESTAMP('2025-09-01')),
    PARTITION p202509 VALUES LESS THAN (UNIX_TIMESTAMP('2025-10-01')),
    PARTITION p202510 VALUES LESS THAN (UNIX_TIMESTAMP('2025-11-01')),
    PARTITION p202511 VALUES LESS THAN (UNIX_TIMESTAMP('2025-12-01')),
    PARTITION p202512 VALUES LESS THAN (UNIX_TIMESTAMP('2026-01-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

**分区管理**:
- **添加新分区**：每月初执行，添加下个月的分区
- **删除旧分区**：根据数据保留策略（如保留12个月），删除过期分区
- **分区裁剪**：查询时指定 `create_time` 范围，MySQL自动裁剪到相关分区

**分区管理SQL示例**:
```sql
-- 添加下个月分区（每月1号执行）
ALTER TABLE wedding_order_timeout_log 
REORGANIZE PARTITION p_future INTO (
    PARTITION p202601 VALUES LESS THAN (UNIX_TIMESTAMP('2026-02-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 删除12个月前的分区（数据保留12个月）
ALTER TABLE wedding_order_timeout_log DROP PARTITION p202501;
```

---

## 八、字典常量

### 7.1 场次类型 (PeriodType)

```php
class PeriodType
{
    const MORNING = 1;    // 早场（早司仪）
    const NOON = 2;       // 午场（午宴）
    const EVENING = 3;    // 晚场（晚宴）
    const FULL_DAY = 4;   // 全天（独立场次，用于全天套餐）
    
    public static function getList(): array
    {
        return [
            self::MORNING => '早场',
            self::NOON => '午场',
            self::EVENING => '晚场',
            self::FULL_DAY => '全天'
        ];
    }
    
    /**
     * 获取分场次列表（不包含全天）
     */
    public static function getPeriodList(): array
    {
        return [
            self::MORNING => '早场',
            self::NOON => '午场',
            self::EVENING => '晚场'
        ];
    }
}
```

### 7.2 订单状态 (OrderStatus)

```php
class OrderStatus
{
    // 正常状态（正数）
    const PENDING = 0;         // 待审核
    const APPROVED = 1;        // 已同意
    const PAID = 2;            // 已付款
    const WAIT_SERVICE = 3;    // 待服务
    const COMPLETED = 4;       // 已完成
    const REFUNDING = 5;       // 退款审核中
    
    // 异常/终态（负数）
    const REJECTED = -1;       // 已拒绝
    const CANCELLED = -2;      // 已取消
    const REFUNDED = -3;       // 已退款
    const CLOSED = -4;         // 已关闭（管理员强制关闭，终态）
    
    public static function getList(): array
    {
        return [
            self::PENDING => '待审核',
            self::APPROVED => '已同意',
            self::PAID => '已付款',
            self::WAIT_SERVICE => '待服务',
            self::COMPLETED => '已完成',
            self::REFUNDING => '退款审核中',
            self::REJECTED => '已拒绝',
            self::CANCELLED => '已取消',
            self::REFUNDED => '已退款',
            self::CLOSED => '已关闭'
        ];
    }
    
    /**
     * 获取终态列表（不可再流转的状态）
     */
    public static function getFinalStatusList(): array
    {
        return [
            self::REJECTED,
            self::CANCELLED,
            self::REFUNDED,
            self::CLOSED
        ];
    }
    
    /**
     * 判断是否为终态
     */
    public static function isFinalStatus(int $status): bool
    {
        return in_array($status, self::getFinalStatusList());
    }
}
```

### 7.3 档期状态 (ScheduleStatus)

```php
class ScheduleStatus
{
    const FREE = 0;       // 空闲
    const REST = 1;       // 休息
    const BOOKED = 2;     // 已预订
    
    public static function getList(): array
    {
        return [
            self::FREE => '空闲',
            self::REST => '休息',
            self::BOOKED => '已预订'
        ];
    }
}
```

### 7.4 服务类型 (ServiceType)

```php
class ServiceType
{
    const PACKAGE = 1;    // 基础套餐
    const ADDON = 2;      // 增值服务
    
    public static function getList(): array
    {
        return [
            self::PACKAGE => '基础套餐',
            self::ADDON => '增值服务'
        ];
    }
}
```

---

## 九、索引设计

### 9.1 索引策略

1. **主键索引**: 所有表使用自增ID作为主键
2. **唯一索引**: 订单编号、用户OpenID等需要唯一性保证的字段
3. **普通索引**: 常用查询字段、外键字段
4. **联合索引**: 组合查询条件（最左前缀原则）
5. **前缀索引**: 用于长文本字段（如label_ids）

### 9.0 索引清单（统一整理）

**主键索引（所有表）**:
- 所有表：`PRIMARY KEY (id)`

**唯一索引**:
- `wedding_service_type`: `uk_type_code (type_code)`
- `wedding_order`: `uk_order_no (order_no)`
- `wedding_refund_apply`: `uk_refund_no (refund_no)`
- `wedding_member`: `uk_openid (openid)`
- `wedding_admin`: `uk_username (username)`
- `wedding_config`: `uk_key (key)`
- `wedding_diy_page`: `uk_name (name)`
- `wedding_service_provider_schedule`: `uk_provider_date_time (provider_id, date, start_time, end_time)`
- `wedding_service_provider_favorite`: `uk_member_provider (member_id, provider_id)`
- `wedding_dynamic_like`: `uk_dynamic_member (dynamic_id, member_id)`
- `wedding_message_read`: `uk_message_member (message_id, member_id)`

### 9.2 服务提供者表索引

```sql
-- 服务提供者表索引
ALTER TABLE `wedding_service_provider` 
ADD INDEX `idx_service_type_status` (`service_type`, `status`),
ADD INDEX `idx_service_type_sort` (`service_type`, `sort`),
ADD INDEX `idx_service_type_score` (`service_type`, `avg_score`),
ADD INDEX `idx_service_type_order_count` (`service_type`, `order_count`),
ADD INDEX `idx_label_ids` (`label_ids`(100));  -- 前缀索引，用于标签搜索
```

**索引说明**:
- `idx_service_type_status`: 用于按服务类型和状态筛选（最常用）
- `idx_service_type_sort`: 用于按服务类型排序
- `idx_service_type_score`: 用于按评分排序
- `idx_service_type_order_count`: 用于按订单量排序
- `idx_label_ids`: 前缀索引，用于标签搜索（MySQL 5.7+支持）

### 9.3 订单表索引

```sql
-- 订单表索引
ALTER TABLE `wedding_order`
ADD INDEX `idx_service_type_status` (`service_type`, `order_status`),
ADD INDEX `idx_provider_status` (`provider_id`, `order_status`),
ADD INDEX `idx_member_status` (`member_id`, `order_status`),
ADD INDEX `idx_date_status` (`reservation_date`, `order_status`),
ADD INDEX `idx_create_time_status` (`create_time`, `order_status`);  -- 用于超时查询
```

**索引说明**:
- `uk_order_no`: 订单编号唯一索引，用于订单号查询
- `idx_service_type_status`: 管理端按服务类型和状态筛选
- `idx_provider_status`: 服务提供者查看自己的订单
- `idx_member_status`: 用户查看自己的订单
- `idx_date_status`: 按日期和状态查询
- `idx_create_time_status`: 用于订单超时查询（重要）

### 9.4 档期表索引

```sql
-- 档期表索引
ALTER TABLE `wedding_service_provider_schedule`
ADD INDEX `idx_provider_date` (`provider_id`, `date`),
ADD INDEX `idx_date_status` (`date`, `status`),
ADD INDEX `idx_date_period_status` (`date`, `period`, `status`);  -- 用于档期查询
```

**索引说明**:
- `uk_provider_date_time`: 服务提供者+日期+时间段联合唯一索引，防止时间段重叠冲突
  - **重要**：唯一索引基于 `(provider_id, date, start_time, end_time)`，而非 `period`
  - `period` 字段仅用于前端展示，不参与业务判断和唯一约束
  - 应用层必须在订单创建前检查时间段重叠，防止并发下单导致超售
  - 时间段重叠判断公式：`(start_time1 < end_time2) AND (end_time1 > start_time2)`
- `idx_provider_date`: 用于查询某个服务提供者的档期
- `idx_date_status`: 用于按日期和状态查询
- `idx_date_period_status`: 用于档期查询（最常用，但注意 period 仅用于展示）

### 9.5 评价表索引

```sql
-- 评价表索引
ALTER TABLE `wedding_review`
ADD INDEX `idx_service_type_provider` (`service_type`, `provider_id`),
ADD INDEX `idx_provider_status` (`provider_id`, `status`),
ADD INDEX `idx_create_time` (`create_time`);
```

### 9.6 动态表索引

```sql
-- 动态表索引
ALTER TABLE `wedding_dynamic`
ADD INDEX `idx_service_type_status` (`service_type`, `status`),
ADD INDEX `idx_provider_status` (`provider_id`, `status`),
ADD INDEX `idx_category_status` (`category_id`, `status`),
ADD INDEX `idx_create_time_status` (`create_time`, `status`);  -- 用于列表排序
```

### 9.7 索引使用建议

1. **避免过度索引**: 每个表索引数量控制在5-8个以内
2. **联合索引顺序**: 按照查询频率和选择性排序
3. **前缀索引**: 对于长文本字段（如label_ids），使用前缀索引
4. **定期分析**: 使用`EXPLAIN`分析查询计划，优化慢查询

---

## 十、数据迁移脚本

### 10.1 从wedding_host迁移到wedding_service_provider

**说明**: 如果已有`wedding_host`表数据，需要迁移到`wedding_service_provider`表

```sql
-- 步骤1: 迁移数据
INSERT INTO `wedding_service_provider` (
    `member_id`, `service_type`, `provider_no`, `realname`, `mobile`, 
    `wechat`, `headimg`, `cover`, `sex`, `birthday`, `id_card`,
    `signature`, `introduction`, `label_ids`, `experience_years`,
    `diy_page_id`, `status`, `sort`, `order_count`, `review_count`,
    `avg_score`, `remark`, `create_time`, `update_time`, `is_deleted`
)
SELECT 
    `member_id`, 'host', `provider_no`, `realname`, `mobile`,
    `wechat`, `headimg`, `cover`, `sex`, `birthday`, `id_card`,
    `signature`, `introduction`, `label_ids`, `experience_years`,
    `diy_page_id`, `status`, `sort`, `order_count`, `review_count`,
    `avg_score`, `remark`, `create_time`, `update_time`, `is_deleted`
FROM `wedding_host`
WHERE `is_deleted` = 0;

-- 步骤2: 更新订单表中的provider_id（如果订单表使用的是host_id）
-- 注意：需要根据实际情况调整，如果旧表有host_id字段，需要迁移
-- UPDATE `wedding_order` o
-- INNER JOIN `wedding_service_provider` p ON o.host_id = p.id AND p.service_type = 'host'
-- SET o.provider_id = p.id
-- WHERE o.provider_id = 0;

-- 步骤3: 验证数据迁移结果
SELECT 
    (SELECT COUNT(*) FROM `wedding_host` WHERE `is_deleted` = 0) as old_count,
    (SELECT COUNT(*) FROM `wedding_service_provider` WHERE `service_type` = 'host') as new_count;

-- 步骤4: 确认数据无误后，删除旧表（谨慎操作！）
-- DROP TABLE IF EXISTS `wedding_host`;
```

### 10.2 初始化脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS Wedding_management 
DEFAULT CHARACTER SET utf8mb4 
DEFAULT COLLATE utf8mb4_general_ci;

USE Wedding_management;

-- 执行建表语句（参考上述表结构）

-- 插入初始数据
INSERT INTO `wedding_admin` (`username`, `password`, `realname`, `role`, `status`, `create_time`) 
VALUES ('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '管理员', 'super_admin', 1, UNIX_TIMESTAMP());

INSERT INTO `wedding_config` (`key`, `value`, `description`, `create_time`) VALUES 
('basic_config', '{"site_name":"婚庆管家","site_logo":""}', '基础配置', UNIX_TIMESTAMP()),
('order_config', '{"auto_cancel_hours":24}', '订单配置', UNIX_TIMESTAMP()),
('review_config', '{"need_audit":false}', '评价配置', UNIX_TIMESTAMP()),
('dynamic_config', '{"need_audit":true}', '动态配置', UNIX_TIMESTAMP());

-- 插入默认标签（按服务类型，仅管理员可管理）
-- 主持人标签
INSERT INTO `wedding_service_provider_label` (`service_type`, `name`, `icon`, `color`, `sort`, `status`, `create_time`) VALUES 
('host', '资深主持', '', '#FF6600', 1, 1, UNIX_TIMESTAMP()),
('host', '婚礼策划', '', '#4ECDC4', 2, 1, UNIX_TIMESTAMP()),
('host', '双语主持', '', '#45B7D1', 3, 1, UNIX_TIMESTAMP()),
('host', '户外婚礼', '', '#96CEB4', 4, 1, UNIX_TIMESTAMP()),
('host', '中式婚礼', '', '#FFEAA7', 5, 1, UNIX_TIMESTAMP()),
('host', '西式婚礼', '', '#DDA0DD', 6, 1, UNIX_TIMESTAMP());

-- 跟拍标签
INSERT INTO `wedding_service_provider_label` (`service_type`, `name`, `icon`, `color`, `sort`, `status`, `create_time`) VALUES 
('photographer', '单机位', '', '#0066FF', 1, 1, UNIX_TIMESTAMP()),
('photographer', '双机位', '', '#0099FF', 2, 1, UNIX_TIMESTAMP()),
('photographer', '多机位', '', '#00CCFF', 3, 1, UNIX_TIMESTAMP()),
('photographer', '航拍', '', '#00FFFF', 4, 1, UNIX_TIMESTAMP()),
('photographer', '纪实风格', '', '#FF6600', 5, 1, UNIX_TIMESTAMP()),
('photographer', '唯美风格', '', '#FF99CC', 6, 1, UNIX_TIMESTAMP());

-- 管家标签
INSERT INTO `wedding_service_provider_label` (`service_type`, `name`, `icon`, `color`, `sort`, `status`, `create_time`) VALUES 
('butler', '迎宾服务', '', '#66CC99', 1, 1, UNIX_TIMESTAMP()),
('butler', '现场协调', '', '#99CC66', 2, 1, UNIX_TIMESTAMP()),
('butler', '收尾服务', '', '#CC9966', 3, 1, UNIX_TIMESTAMP()),
('butler', '全程服务', '', '#9966CC', 4, 1, UNIX_TIMESTAMP());

-- 插入默认动态分类
INSERT INTO `wedding_dynamic_category` (`name`, `sort`, `status`, `create_time`) VALUES 
('婚礼现场', 1, 1, UNIX_TIMESTAMP()),
('幕后花絮', 2, 1, UNIX_TIMESTAMP()),
('新人好评', 3, 1, UNIX_TIMESTAMP()),
('行业资讯', 4, 1, UNIX_TIMESTAMP());
```

---

## 十一、架构优化说明

### 11.1 数据库设计优化

**统一表设计**: 不保留`wedding_host`表，统一使用`wedding_service_provider`表管理所有服务类型。

**理由**:
- 避免数据冗余和维护成本
- 统一数据模型，简化业务逻辑
- 便于扩展新的服务类型

**数据迁移**: 如果已有`wedding_host`表数据，需要迁移到`wedding_service_provider`表（service_type='host'），迁移完成后删除旧表。

### 11.2 索引优化说明

所有索引设计已在第九章详细说明，关键索引包括：

**服务提供者表**:
- `idx_service_type_status`: 按服务类型和状态筛选（最常用）
- `idx_service_type_sort`: 按服务类型排序
- `idx_service_type_score`: 按评分排序

**订单表**:
- `idx_create_time_status`: 用于订单超时查询（重要）
- `idx_service_type_status`: 管理端按服务类型筛选

**档期表**:
- `uk_provider_date_time`: 防止时间段重叠冲突（基于 provider_id, date, start_time, end_time）
- `idx_date_period_status`: 用于档期查询

### 11.3 索引使用建议

1. **避免过度索引**: 每个表索引数量控制在5-8个以内
2. **联合索引顺序**: 按照查询频率和选择性排序
3. **前缀索引**: 对于长文本字段（如label_ids），使用前缀索引
4. **定期分析**: 使用`EXPLAIN`分析查询计划，优化慢查询

---

## 十二、统计指标表设计

### 12.1 日统计表 (wedding_stat_daily)

**说明**: 用于存储每日统计数据，避免实时查询主表拖垮性能。

```sql
CREATE TABLE IF NOT EXISTS `wedding_stat_daily` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `stat_date` date NOT NULL COMMENT '统计日期',
    `service_type` varchar(50) NOT NULL DEFAULT '' COMMENT '服务类型：host/photographer/butler（空=全部）',
    `provider_id` int(10) UNSIGNED NOT NULL DEFAULT 0 COMMENT '服务提供者ID（0=全部）',
    
    -- 订单统计
    `order_count` int(10) NOT NULL DEFAULT 0 COMMENT '订单数量',
    `order_amount` decimal(12,2) NOT NULL DEFAULT 0.00 COMMENT '订单金额（单位：元）',
    `completed_count` int(10) NOT NULL DEFAULT 0 COMMENT '已完成订单数',
    `completed_amount` decimal(12,2) NOT NULL DEFAULT 0.00 COMMENT '已完成订单金额（单位：元）',
    
    -- 转化率
    `conversion_rate` decimal(5,2) NOT NULL DEFAULT 0.00 COMMENT '转化率（%）',
    
    -- 评价统计
    `review_count` int(10) NOT NULL DEFAULT 0 COMMENT '评价数量',
    `avg_score` decimal(3,2) NOT NULL DEFAULT 0.00 COMMENT '平均评分',
    
    -- 用户统计
    `new_member_count` int(10) NOT NULL DEFAULT 0 COMMENT '新增会员数',
    `active_member_count` int(10) NOT NULL DEFAULT 0 COMMENT '活跃会员数',
    `repeat_order_count` int(10) NOT NULL DEFAULT 0 COMMENT '复购订单数',
    `repeat_rate` decimal(5,2) NOT NULL DEFAULT 0.00 COMMENT '复购率（%）',
    
    `create_time` int(11) NOT NULL DEFAULT 0 COMMENT '创建时间',
    `update_time` int(11) NOT NULL DEFAULT 0 COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_date_service_provider` (`stat_date`, `service_type`, `provider_id`),
    KEY `idx_stat_date` (`stat_date`),
    KEY `idx_service_type` (`service_type`),
    KEY `idx_provider_id` (`provider_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='日统计表';
```

**统计任务**:
- **定时任务**：每日凌晨 02:00 执行，统计前一天数据
- **统计维度**：按服务类型、服务提供者、日期维度统计
- **统计内容**：
  - 订单统计：订单数、订单金额、已完成订单数、已完成订单金额
  - 转化率：订单转化率（订单数/访问数）
  - 评价统计：评价数量、平均评分
  - 用户统计：新增会员数、活跃会员数、复购订单数、复购率
- **查询优化**：前端直接查询统计表，避免实时 SUM 计算
- **性能提升**：大促期间并发查询性能提升约 100-1000 倍

**定时任务设计**:
```php
// 每日凌晨 02:00 执行统计任务
class StatDailyTask
{
    public function execute()
    {
        $yesterday = date('Y-m-d', strtotime('-1 day'));
        
        // 按服务类型统计
        $this->statByServiceType($yesterday);
        
        // 按服务提供者统计
        $this->statByProvider($yesterday);
        
        // 按日期统计（汇总）
        $this->statByDate($yesterday);
    }
    
    private function statByServiceType($date)
    {
        // 统计各服务类型的订单、金额、评价等
        // 写入 wedding_stat_daily 表
    }
    
    private function statByProvider($date)
    {
        // 统计各服务提供者的订单、金额、评价等
        // 写入 wedding_stat_daily 表
    }
}
```

**查询示例**:
```sql
-- 查询某服务提供者最近30天的统计数据（从统计表查询，不实时计算）
SELECT 
    stat_date,
    order_count,
    order_amount,
    completed_count,
    completed_amount,
    review_count,
    avg_score
FROM wedding_stat_daily
WHERE provider_id = 1
  AND stat_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
ORDER BY stat_date DESC;
```

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-01

