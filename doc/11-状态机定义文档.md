# 婚庆管家 - 状态机定义文档

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v2.0.0  
**创建日期**: 2025-01-03  
**最后更新**: 2025-01-03

---

## 一、文档说明

本文档是《00-系统设计总纲.md》的细化，详细定义系统中所有状态机的状态迁移规则。

**文档关系**：
- 本文档是《00-系统设计总纲.md》状态机定义章节的详细版本
- 代码实现必须遵循本文档定义的状态迁移规则
- API接口设计必须符合本文档的状态机定义

---

## 二、订单状态机

### 2.1 状态定义

#### 2.1.1 业务主状态（order_status）

| 状态值 | 状态名称 | 常量名 | 业务含义 | 是否终态 |
|-------|---------|--------|---------|---------|
| 0 | 待审核 | CREATED | 用户提交订单，等待服务提供者审核 | ❌ |
| 1 | 已同意 | CONFIRMED | 服务提供者同意，等待付款 | ❌ |
| 3 | 待服务 | SERVING | 付款后等待服务 | ❌ |
| 4 | 已完成 | FINISHED | 服务完成 | ✅ |
| 10 | 已拒绝 | REJECTED | 服务提供者拒绝 | ✅ |
| 11 | 已取消 | CANCELLED | 用户取消 | ✅ |
| 13 | 已关闭 | CLOSED | 管理员强制关闭 | ✅ |

#### 2.1.2 支付状态（payment_status）

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 未付款 | UNPAID | 订单未付款 |
| 1 | 已付款 | PAID | 订单已付款 |
| 2 | 部分退款 | PARTIAL_REFUND | 订单部分退款 |
| 3 | 已退款 | FULL_REFUND | 订单已退款 |

#### 2.1.3 退款状态（refund_status）

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 无退款 | NONE | 无退款申请 |
| 1 | 退款申请中 | APPLY | 用户申请退款 |
| 2 | 退款已同意 | APPROVED | 管理员同意退款 |
| 3 | 退款已拒绝 | REJECTED | 管理员拒绝退款 |
| 4 | 退款已完成 | COMPLETED | 退款流程完成 |

### 2.2 业务主状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| CREATED(0) | CONFIRMED(1) | provider | POST /api/v1/order/approve | order_status=0, payment_status=0, refund_status=0 | 发送通知给用户 | 服务提供者同意订单 |
| CREATED(0) | REJECTED(10) | provider | POST /api/v1/order/reject | order_status=0 | 释放档期，发送通知给用户 | 服务提供者拒绝订单 |
| CREATED(0) | CANCELLED(11) | user | POST /api/v1/order/cancel | order_status=0 | 释放档期，发送通知给服务提供者 | 用户取消订单 |
| CREATED(0) | CLOSED(13) | admin | POST /admin/order/close | order_status=0 | 释放档期，发送通知 | 管理员强制关闭 |
| CONFIRMED(1) | SERVING(3) | system | 自动流转 | order_status=1, payment_status=1 | 发送通知给用户和服务提供者 | 付款后自动流转 |
| CONFIRMED(1) | CANCELLED(11) | user | POST /api/v1/order/cancel | order_status=1, payment_status=0 | 释放档期，发送通知 | 用户取消订单 |
| CONFIRMED(1) | CLOSED(13) | admin | POST /admin/order/close | order_status=1 | 释放档期，发送通知 | 管理员强制关闭 |
| SERVING(3) | FINISHED(4) | provider | POST /api/v1/order/complete | order_status=3 | 发送通知给用户，允许评价 | 服务提供者确认完成 |
| SERVING(3) | CLOSED(13) | admin | POST /admin/order/close | order_status=3 | 发送通知 | 管理员强制关闭 |
| FINISHED(4) | - | - | - | - | 终态，不可再流转 | - |
| REJECTED(10) | - | - | - | - | 终态，不可再流转 | - |
| CANCELLED(11) | - | - | - | - | 终态，不可再流转 | - |
| CLOSED(13) | - | - | - | - | 终态，不可再流转 | - |

### 2.3 支付状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| UNPAID(0) | PAID(1) | admin | POST /admin/order/confirmPayment | order_status=CONFIRMED(1), payment_status=0 | 自动流转order_status=SERVING(3)，发送通知 | 管理员确认付款 |
| PAID(1) | PARTIAL_REFUND(2) | admin | POST /admin/order/confirmRefund | payment_status=1, refund_status=APPROVED(2) | 发送通知 | 部分退款完成 |
| PAID(1) | FULL_REFUND(3) | admin | POST /admin/order/confirmRefund | payment_status=1, refund_status=COMPLETED(4), 全额退款 | 发送通知，可选：流转order_status=CANCELLED(11) | 全额退款完成 |

### 2.4 退款状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| NONE(0) | APPLY(1) | user | POST /api/v1/order/refund | order_status=SERVING(3), payment_status=PAID(1), refund_status=0 | 发送通知给管理员 | 用户申请退款 |
| APPLY(1) | APPROVED(2) | admin | POST /admin/order/auditRefund | refund_status=APPLY(1) | 发送通知给用户 | 管理员同意退款 |
| APPLY(1) | REJECTED(3) | admin | POST /admin/order/auditRefund | refund_status=APPLY(1) | 发送通知给用户 | 管理员拒绝退款 |
| APPROVED(2) | COMPLETED(4) | admin | POST /admin/order/confirmRefund | refund_status=APPROVED(2) | 更新payment_status，释放档期（部分退款时），发送通知 | 退款完成 |

### 2.5 状态组合规则

**合法状态组合表**：

| order_status | payment_status | refund_status | 业务含义 | 是否合法 |
|-------------|----------------|---------------|---------|---------|
| CREATED(0) | UNPAID(0) | NONE(0) | 待审核，未付款 | ✅ |
| CONFIRMED(1) | UNPAID(0) | NONE(0) | 已同意，待付款 | ✅ |
| CONFIRMED(1) | PAID(1) | NONE(0) | 已同意，已付款（应自动流转为SERVING） | ⚠️（临时状态） |
| SERVING(3) | PAID(1) | NONE(0) | 待服务，已付款 | ✅ |
| SERVING(3) | PAID(1) | APPLY(1) | 待服务，已付款，退款申请中 | ✅ |
| SERVING(3) | PAID(1) | APPROVED(2) | 待服务，已付款，退款已同意 | ✅ |
| SERVING(3) | PAID(1) | REJECTED(3) | 待服务，已付款，退款已拒绝 | ✅ |
| SERVING(3) | PARTIAL_REFUND(2) | COMPLETED(4) | 待服务，部分退款已完成 | ✅ |
| SERVING(3) | FULL_REFUND(3) | COMPLETED(4) | 待服务，已退款（应流转为CANCELLED） | ⚠️（临时状态） |
| FINISHED(4) | PAID(1) | NONE(0) | 已完成，已付款 | ✅ |
| REJECTED(10) | UNPAID(0) | NONE(0) | 已拒绝，未付款（终态） | ✅ |
| CANCELLED(11) | UNPAID(0) | NONE(0) | 已取消，未付款（终态） | ✅ |
| CANCELLED(11) | PAID(1) | COMPLETED(4) | 已取消，已退款（终态） | ✅ |

**非法状态组合示例**：
- `order_status=CREATED(0)` + `payment_status=PAID(1)` ❌（待审核状态不能已付款）
- `order_status=FINISHED(4)` + `refund_status=APPLY(1)` ❌（已完成订单不能申请退款）
- `order_status=REJECTED(10)` + `payment_status=PAID(1)` ❌（已拒绝订单不能已付款）

### 2.6 状态迁移校验规则

**规则1：前置条件校验**
- 必须检查当前状态是否符合前置条件
- 必须检查状态组合是否合法

**规则2：权限校验**
- 必须检查操作人角色是否符合ALLOWED_ROLE
- 必须检查操作人是否有权限操作该订单

**规则3：后置动作执行**
- 必须执行后置动作（发送通知、释放档期等）
- 必须记录状态日志

**规则4：并发控制**
- 状态变更前必须锁定订单记录（SELECT FOR UPDATE）
- 检查状态是否已变更（乐观锁）

---

## 三、档期状态机

### 3.1 状态定义

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 空闲 | FREE | 档期空闲，可被预约 |
| 1 | 休息 | REST | 档期休息，不可预约 |
| 2 | 已预订 | BOOKED | 档期已被订单占用 |

### 3.2 状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| FREE(0) | REST(1) | provider | POST /api/v1/schedule/set | status=FREE(0) | - | 服务提供者设置休息 |
| FREE(0) | BOOKED(2) | system | 订单创建时自动 | status=FREE(0), 档期可用（时间段不冲突） | 关联order_id | 订单创建时自动锁定 |
| REST(1) | FREE(0) | provider | POST /api/v1/schedule/set | status=REST(1) | - | 服务提供者取消休息 |
| BOOKED(2) | FREE(0) | system | 订单取消/拒绝时自动 | status=BOOKED(2) | 清空order_id | 订单取消/拒绝时自动释放 |

### 3.3 档期冲突检测规则

**规则1：时间段重叠检测**
- 冲突判断公式：`(start_time1 < end_time2) AND (end_time1 > start_time2)`
- 如果两个时间段有重叠，则冲突

**规则2：唯一索引约束**
- 数据库唯一索引：`uk_provider_date_time` (provider_id, date, start_time, end_time)
- 防止并发情况下的冲突

**规则3：应用层校验**
- 订单创建前必须检查时间段重叠
- 使用事务锁（SELECT FOR UPDATE）锁定相关档期记录

---

## 四、退款申请状态机

### 4.1 状态定义

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 待审核 | PENDING | 退款申请待审核 |
| 1 | 已同意 | APPROVED | 管理员同意退款 |
| 2 | 已拒绝 | REJECTED | 管理员拒绝退款 |
| 3 | 已完成 | COMPLETED | 退款已完成 |

### 4.2 状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| PENDING(0) | APPROVED(1) | admin | POST /admin/refund/audit | status=PENDING(0) | 发送通知给用户 | 管理员同意退款 |
| PENDING(0) | REJECTED(2) | admin | POST /admin/refund/audit | status=PENDING(0) | 发送通知给用户 | 管理员拒绝退款 |
| APPROVED(1) | COMPLETED(3) | admin | POST /admin/refund/confirm | status=APPROVED(1) | 更新订单payment_status和refund_status，释放档期（部分退款时），发送通知 | 退款完成 |
  - **释放档期逻辑**（部分退款时）：
    - 解析退款申请的 `refund_items` JSON字段
    - 对于 `type="period"` 的退款项，通过 `period_id` 找到对应的 `wedding_order_period` 记录
    - 根据订单的 `reservation_date` 和 `order_period` 中的场次信息，反向查找对应的档期记录（通过 `provider_id + date + start_time + end_time` 匹配）
    - 将对应档期记录的 `order_id` 置为 0，`status` 置为 0（空闲）
    - **重要**：只释放 `refund_items` 里指定的场次档期，未退款的场次档期保持已预订状态

---

## 五、评价状态机

### 5.1 状态定义

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 待审核 | PENDING | 评价待审核 |
| 1 | 显示 | SHOW | 评价已显示 |
| 2 | 隐藏 | HIDDEN | 评价已隐藏 |

### 5.2 状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| PENDING(0) | SHOW(1) | admin | POST /admin/review/audit | status=PENDING(0) | 更新服务提供者评分统计 | 管理员审核通过 |
| PENDING(0) | HIDDEN(2) | admin | POST /admin/review/audit | status=PENDING(0) | - | 管理员审核拒绝 |
| SHOW(1) | HIDDEN(2) | admin | POST /admin/review/hide | status=SHOW(1) | - | 管理员隐藏评价 |

---

## 六、动态状态机

### 6.1 状态定义

| 状态值 | 状态名称 | 常量名 | 业务含义 |
|-------|---------|--------|---------|
| 0 | 待审核 | PENDING | 动态待审核 |
| 1 | 已发布 | PUBLISHED | 动态已发布 |
| 2 | 已拒绝 | REJECTED | 动态已拒绝 |
| 3 | 已下架 | OFFLINE | 动态已下架 |

### 6.2 状态迁移矩阵

| FROM | TO | ALLOWED_ROLE | API | 前置条件 | 后置动作 | 说明 |
|------|----|--------------|-----|---------|---------|------|
| PENDING(0) | PUBLISHED(1) | admin | POST /admin/dynamic/audit | status=PENDING(0) | - | 管理员审核通过 |
| PENDING(0) | REJECTED(2) | admin | POST /admin/dynamic/audit | status=PENDING(0) | - | 管理员审核拒绝 |
| PUBLISHED(1) | OFFLINE(3) | admin/provider | POST /admin/dynamic/offline 或 POST /api/v1/dynamic/delete | status=PUBLISHED(1) | - | 下架动态 |

---

## 七、状态机实现规范

### 7.1 代码实现要求

**必须实现的功能**：
1. 状态迁移校验（前置条件检查）
2. 权限校验（ALLOWED_ROLE检查）
3. 状态组合合法性校验
4. 并发控制（锁机制）
5. 状态日志记录
6. 后置动作执行（通知、档期释放等）

**禁止的操作**：
1. 禁止直接UPDATE状态字段
2. 禁止跳过状态机校验
3. 禁止非法状态组合

### 7.2 状态机类设计

**类结构**：
```php
class OrderStateMachine
{
    // 状态迁移定义
    private static $transitions = [
        // FROM => [TO => [ALLOWED_ROLE, API, 前置条件, 后置动作]]
    ];
    
    // 状态组合规则
    private static $validCombinations = [
        // [order_status, payment_status, refund_status] => 是否合法
    ];
    
    // 状态迁移方法
    public function transition($orderId, $toStatus, $operatorRole, $operatorId, $reason = '')
    {
        // 1. 锁定订单记录
        // 2. 检查前置条件
        // 3. 检查权限
        // 4. 检查状态组合合法性
        // 5. 执行状态变更
        // 6. 记录状态日志
        // 7. 执行后置动作
    }
}
```

---

## 八、状态机扩展规则

### 8.1 新增状态

**步骤**：
1. 在状态定义表中添加新状态
2. 在状态迁移矩阵中添加迁移规则
3. 更新状态组合规则
4. 更新代码实现
5. 更新相关文档

### 8.2 新增状态迁移

**步骤**：
1. 在状态迁移矩阵中添加迁移规则
2. 定义前置条件、后置动作
3. 更新代码实现
4. 更新相关文档

---

**文档版本**: v2.0.0  
**最后更新**: 2025-01-03

