# 婚庆管家 - 异常与边界场景说明

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v2.0.0  
**创建日期**: 2025-01-03  
**最后更新**: 2025-01-03

---

## 一、错误码规范

### 1.1 错误码分段规则

**规范说明**：所有错误码必须遵循分段规则，确保错误码的唯一性和可维护性。

| code范围 | 模块 | 说明 | 详细范围 |
|---------|------|------|---------|
| 0 | 成功 | 操作成功 | - |
| 1xxx | 参数错误 | 参数验证、格式错误 | 1001-1999 |
| 2xxx | 订单模块 | 订单相关错误 | 2001-2999 |
| 3xxx | 档期模块 | 档期相关错误 | 3001-3999 |
| 4xxx | 支付/退款模块 | 支付退款相关错误 | 4001-4999 |
| 5xxx | 评价模块 | 评价相关错误 | 5001-5999 |
| 6xxx | 动态模块 | 动态相关错误 | 6001-6999 |
| 7xxx | 服务提供者模块 | 服务提供者相关错误 | 7001-7999 |
| 8xxx | 内容模块 | 内容管理相关错误 | 8001-8999 |
| 9xxx | 系统级错误 | 系统异常、数据库错误等 | 9001-9999 |

**错误码使用规范**：
- 新增错误码必须遵循分段规则
- 错误码定义必须包含：错误码、说明、模块、触发场景
- API文档中的错误响应必须引用本文档
- 代码中的错误码必须通过枚举类或常量定义，禁止魔法数字

---

## 二、异常场景分类

### 2.1 参数非法（1xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 必填参数缺失 | 1001 | 返回参数错误，提示缺失字段 | 创建订单缺少provider_id | 本文档2.1 |
| 参数类型错误 | 1001 | 返回参数错误，提示类型不匹配 | provider_id传入字符串 | 本文档2.1 |
| 参数值超出范围 | 1001 | 返回参数错误，提示取值范围 | page_size传入100（最大50） | 本文档2.1 |
| 参数格式错误 | 1001 | 返回参数错误，提示正确格式 | reservation_date格式错误 | 本文档2.1 |
| 系统繁忙 | 1002 | 返回系统错误，提示稍后重试 | 数据库连接失败 | 本文档2.1 |
| 请求频率过高 | 1003 | 返回频率限制错误 | 请求频率超过限制 | 本文档2.1 |

### 2.2 状态非法（2xxx/3xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 订单状态不允许此操作 | 2002 | 返回状态错误，提示当前状态和允许的操作 | 待审核订单不能确认完成 | 本文档2.2、《11-状态机定义文档.md》 |
| 订单状态组合不合法 | 2002 | 返回状态错误，提示状态组合不符合业务规则 | order_status+payment_status+refund_status组合非法 | 本文档2.2、《00-系统设计总纲.md》 |
| 订单已终态 | 2002 | 返回状态错误，提示订单已结束 | 已取消订单不能再次操作 | 本文档2.2、《11-状态机定义文档.md》 |
| 档期状态不允许预约 | 3003 | 返回状态错误，提示档期不可用 | 档期状态为休息或已预订 | 本文档2.2、《11-状态机定义文档.md》 |

### 2.3 重复提交（2xxx/4xxx/5xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 订单重复创建 | 2005 | 通过client_request_id幂等，返回已存在订单 | 相同client_request_id重复提交 | 本文档2.3 |
| 退款重复申请 | 4003 | 通过client_request_id幂等，返回已存在退款申请 | 相同client_request_id重复申请 | 本文档2.3 |
| 评价重复提交 | 5001 | 检查订单是否已评价，返回已存在评价 | 同一订单重复提交评价 | 本文档2.3 |

### 2.4 并发冲突（2xxx/3xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 档期并发占用 | 3001 | 使用数据库唯一索引+事务，返回档期已被占用 | 两个用户同时预约同一档期（时间段重叠） | 本文档2.4、《00-系统设计总纲.md》 |
| 订单并发审核 | 2006 | 使用SELECT FOR UPDATE行锁，返回订单正在处理 | 管理员和服务提供者同时审核 | 本文档2.4 |
| 状态并发修改 | 2002 | 使用乐观锁或悲观锁，返回状态已变更 | 订单状态被其他操作修改 | 本文档2.4 |

### 2.5 权限不足（HTTP状态码）

| 场景 | HTTP状态码 | 处理方式 | 示例 | 错误码来源 |
|-----|-----------|---------|------|-----------|
| 未登录 | 401 | 返回未授权，要求登录 | 未登录访问需认证接口 | 本文档2.5 |
| Token失效 | 401 | 返回Token失效，要求重新登录 | Token过期或无效 | 本文档2.5 |
| 无权限访问 | 403 | 返回禁止访问，提示所需权限 | 普通用户访问管理员接口 | 本文档2.5 |
| 资源不属于用户 | 403 | 返回禁止访问，提示资源归属 | 用户操作其他用户的订单 | 本文档2.5 |

---

## 三、边界场景

### 3.1 数据边界（1xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 分页超出范围 | 1001 | 返回空列表，total=0 | page=999，无数据 | 本文档3.1 |
| 日期超出范围 | 1001 | 返回参数错误 | reservation_date为过去日期 | 本文档3.1 |
| 金额为0或负数 | 1001 | 返回参数错误 | total_amount <= 0 | 本文档3.1 |
| 数组为空 | 1001 | 返回参数错误 | periods为空数组 | 本文档3.1 |
| 字符串超长 | 1001 | 返回参数错误 | contact_name超过50字符 | 本文档3.1 |

### 3.2 业务边界（2xxx/3xxx/7xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 服务提供者不存在 | 7001 | 返回资源不存在 | provider_id=99999 | 本文档3.2 |
| 服务提供者已禁用 | 7002 | 返回资源已禁用 | status=0的服务提供者 | 本文档3.2 |
| 套餐不存在 | 7003 | 返回资源不存在 | package_id不存在 | 本文档3.2 |
| 档期不存在 | 3002 | 返回资源不存在 | 查询不存在的档期 | 本文档3.2 |
| 订单不存在 | 2001 | 返回资源不存在 | order_id不存在 | 本文档3.2 |
| 订单不属于用户 | 403 | 返回禁止访问 | 用户操作其他用户的订单 | 本文档3.2 |

### 3.3 时间边界（1xxx/2xxx）

| 场景 | 错误码 | 处理方式 | 示例 | 错误码来源 |
|-----|--------|---------|------|-----------|
| 预约日期为过去 | 1001 | 返回参数错误 | reservation_date < 今天 | 本文档3.3 |
| 预约日期过远 | 1001 | 返回参数错误 | reservation_date > 今天+365天 | 本文档3.3 |
| 订单超时 | 2003 | 定时任务自动处理 | 待审核超过48小时 | 本文档3.3 |
| Token过期 | 401 | 返回401，要求重新登录 | Token超过有效期 | 本文档3.3 |

---

## 四、并发处理策略

### 4.1 订单创建并发

**场景**: 两个用户同时预约同一档期

**处理策略**:
1. 使用数据库唯一索引：`uk_provider_date_time (provider_id, date, start_time, end_time)`
2. 使用数据库事务：BEGIN...COMMIT
3. 先检查档期状态，再锁定档期
4. 如果插入失败（唯一索引冲突），返回错误码3001

**代码示例**:
```php
DB::startTrans();
try {
    // 检查档期状态
    $schedule = ScheduleModel::where([
        'provider_id' => $providerId,
        'date' => $date,
        'period' => $period
    ])->lock(true)->find();
    
    if ($schedule && $schedule->status == 2) {
        throw new Exception('档期已被占用', 3001);
    }
    
    // 创建订单
    $order = OrderModel::create($orderData);
    
    // 锁定档期
    ScheduleModel::update([
        'status' => 2,
        'order_id' => $order->id
    ], ['id' => $schedule->id]);
    
    DB::commit();
} catch (\Exception $e) {
    DB::rollback();
    throw $e;
}
```

### 4.2 订单审核并发

**场景**: 管理员和服务提供者同时审核同一订单

**处理策略**:
1. 使用SELECT FOR UPDATE行锁
2. 检查订单状态是否已变更
3. 如果状态已变更，返回错误码2002

**代码示例**:
```php
DB::startTrans();
try {
    $order = OrderModel::where('id', $orderId)
        ->lock(true)
        ->find();
    
    if ($order->order_status != OrderStatus::PENDING) {
        throw new Exception('订单状态不允许此操作', 2002);
    }
    
    // 更新订单状态
    $order->order_status = OrderStatus::APPROVED;
    $order->save();
    
    DB::commit();
} catch (\Exception $e) {
    DB::rollback();
    throw $e;
}
```

### 4.3 幂等性处理

**场景**: 用户重复提交订单

**处理策略**:
1. 检查 `member_id + client_request_id` 是否已存在（联合唯一索引）
2. 如果已存在，返回已创建的订单/退款申请
3. 防止跨用户重放攻击（A用户不能重放B用户的请求）
2. 如果存在，返回已创建的订单
3. 如果不存在，创建新订单

**代码示例**:
```php
// 检查幂等键
if (!empty($clientRequestId)) {
    $existingOrder = OrderModel::where('client_request_id', $clientRequestId)->find();
    if ($existingOrder) {
        return $this->success([
            'order_id' => $existingOrder->id,
            'order_no' => $existingOrder->order_no,
            'total_amount' => $existingOrder->total_amount
        ]);
    }
}

// 创建新订单
$order = OrderModel::create([
    'client_request_id' => $clientRequestId,
    // ... 其他字段
]);
```

---

## 五、错误处理规范

### 5.1 错误码使用规范

**错误码分段规则**（必须遵循）：
| 错误类型 | 错误码范围 | 示例 | 错误码来源 |
|---------|-----------|------|-----------|
| 参数错误 | 1xxx (1001-1999) | 必填参数缺失、参数类型错误 | 本文档1.1 |
| 订单错误 | 2xxx (2001-2999) | 订单不存在、状态非法 | 本文档1.1 |
| 档期错误 | 3xxx (3001-3999) | 档期已被占用、档期不存在 | 本文档1.1 |
| 支付/退款错误 | 4xxx (4001-4999) | 支付凭证格式错误、退款金额超限 | 本文档1.1 |
| 评价错误 | 5xxx (5001-5999) | 评价已提交、订单未完成 | 本文档1.1 |
| 动态错误 | 6xxx (6001-6999) | 动态不存在、动态已删除 | 本文档1.1 |
| 服务提供者错误 | 7xxx (7001-7999) | 服务提供者不存在、已禁用 | 本文档1.1 |
| 内容错误 | 8xxx (8001-8999) | 公告不存在、轮播图不存在 | 本文档1.1 |
| 系统级错误 | 9xxx (9001-9999) | 数据库连接失败、系统异常 | 本文档1.1 |

**错误码定义要求**：
- 所有错误码必须包含：错误码、说明、模块、触发场景
- API文档中的错误响应必须引用本文档
- 代码中的错误码必须通过枚举类或常量定义

### 5.2 错误响应格式

```json
{
    "code": 2002,
    "msg": "订单状态不允许此操作，当前状态：已取消，允许操作：无",
    "data": null,
    "error_detail": {
        "current_status": -2,
        "current_status_name": "已取消",
        "allowed_operations": []
    }
}
```

---

## 六、异常场景测试用例

### 6.1 订单创建异常测试

| 测试用例 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 档期已被占用 | 已预订的档期 | 错误码3001 | 返回正确错误码和提示 |
| 服务提供者不存在 | provider_id=99999 | 错误码7001 | 返回资源不存在 |
| 套餐不存在 | package_id=99999 | 错误码7003 | 返回资源不存在 |
| 预约日期为过去 | reservation_date=昨天 | 错误码1001 | 返回参数错误 |
| 重复提交 | 相同client_request_id | 返回已存在订单 | 幂等性生效 |
| 并发创建 | 两个请求同时创建 | 只有一个成功 | 并发控制生效 |

### 6.2 订单审核异常测试

| 测试用例 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 状态非法 | 已取消订单执行同意 | 错误码2002 | 返回状态错误 |
| 权限不足 | 普通用户审核订单 | 错误码403 | 返回权限错误 |
| 订单不属于服务提供者 | 服务提供者审核其他订单 | 错误码403 | 返回权限错误 |
| 并发审核 | 两个请求同时审核 | 只有一个成功 | 并发控制生效 |

---

---

## 七、错误码完整列表

### 7.1 1xxx - 参数错误

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 1001 | 参数错误 | 必填参数缺失、参数类型错误、参数值超出范围、参数格式错误 | 本文档2.1、3.1、3.3 |
| 1002 | 系统繁忙，请稍后重试 | 系统异常、数据库连接失败 | 本文档 |
| 1003 | 请求频率过高 | 请求频率超过限制 | 本文档2.1 |

### 7.2 2xxx - 订单模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 2001 | 订单不存在 | order_id不存在 | 本文档3.2 |
| 2002 | 订单状态不允许此操作 | 状态非法流转、状态组合不合法、状态并发修改 | 本文档2.2、2.4、《11-状态机定义文档.md》 |
| 2003 | 订单已过期 | 订单超时 | 本文档3.3 |
| 2004 | 订单金额计算错误 | 订单金额计算异常 | 本文档 |
| 2005 | 订单重复创建 | 相同client_request_id重复提交 | 本文档2.3 |
| 2006 | 订单正在处理 | 并发审核冲突 | 本文档2.4 |

### 7.3 3xxx - 档期模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 3001 | 档期已被占用 | 时间段重叠冲突（并发占用） | 本文档2.4、《00-系统设计总纲.md》 |
| 3002 | 档期不存在 | schedule_id不存在 | 本文档3.2 |
| 3003 | 档期状态不允许预约 | 档期状态为休息或已预订 | 本文档2.2、《11-状态机定义文档.md》 |

### 7.4 4xxx - 支付/退款模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 4001 | 支付凭证格式错误 | 支付凭证图片格式不正确 | 本文档 |
| 4002 | 退款金额超过订单金额 | 退款金额计算错误 | 本文档 |
| 4003 | 退款申请已存在 | 相同client_request_id重复申请 | 本文档2.3 |

### 7.5 5xxx - 评价模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 5001 | 评价已提交 | 同一订单重复提交评价 | 本文档2.3 |
| 5002 | 订单未完成，无法评价 | 订单状态不是已完成 | 本文档2.2 |

### 7.6 6xxx - 动态模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 6001 | 动态不存在 | dynamic_id不存在 | 本文档3.2 |
| 6002 | 动态已删除 | 动态已被逻辑删除 | 本文档3.2 |

### 7.7 7xxx - 服务提供者模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 7001 | 服务提供者不存在 | provider_id不存在 | 本文档3.2 |
| 7002 | 服务提供者已禁用 | 服务提供者status=0 | 本文档3.2 |
| 7003 | 套餐不存在 | package_id不存在 | 本文档3.2 |

### 7.8 8xxx - 内容模块

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 8001 | 公告不存在 | notice_id不存在 | 本文档3.2 |
| 8002 | 轮播图不存在 | banner_id不存在 | 本文档3.2 |

### 7.9 9xxx - 系统级错误

| code | 说明 | 触发场景 | 错误码来源 |
|------|------|---------|-----------|
| 9001 | 数据库连接失败 | 数据库异常 | 本文档 |
| 9002 | 系统异常 | 未捕获的异常 | 本文档 |

---

**文档版本**: v2.0.0  
**最后更新**: 2025-01-03

