# 婚庆管家 - 系统强约束说明

**项目名称**: 婚庆管家（Wedding Host Manager）  
**版本**: v2.0.0  
**创建日期**: 2025-01-03  
**最后更新**: 2025-01-03

---

## 一、文档说明

本文档说明如何将文档中的"好的实践"升级为"系统强约束"，确保代码实现与文档定义一致。

**升级目标**：
- 枚举 → 代码生成（禁止魔法数字）
- 状态 → 状态机（自动校验）
- 字段字典 → 校验 & 自动文档

---

## 二、枚举代码生成

### 2.1 设计原则

**原则1：禁止魔法数字**
- 所有枚举值必须通过枚举类定义
- 代码中禁止直接使用数字常量
- 枚举类自动生成自《08-数据字段字典.md》

**原则2：自动生成文档**
- 枚举类包含完整的枚举值定义
- 枚举类包含业务含义说明
- 前端通过API获取枚举定义

**原则3：统一管理**
- 所有枚举类放在 `app/dict/` 目录
- 枚举类命名规范：`{Entity}Status.php` 或 `{Entity}Type.php`
- 枚举类必须包含 `getAll()`、`getName()`、`isValid()` 方法

### 2.2 已实现的枚举类

**订单状态枚举**：
- `app/dict/OrderStatus.php` - 订单业务主状态
- `app/dict/PaymentStatus.php` - 支付状态
- `app/dict/RefundStatus.php` - 退款状态

**档期状态枚举**：
- `app/dict/ScheduleStatus.php` - 档期状态

### 2.3 使用示例

```php
// ✅ 正确：使用枚举类
use app\dict\OrderStatus;

$order->order_status = OrderStatus::CONFIRMED;
if (OrderStatus::isFinal($order->order_status)) {
    // 处理终态
}

// ❌ 错误：使用魔法数字
$order->order_status = 1;
if ($order->order_status == 4 || $order->order_status == 10) {
    // 处理终态
}
```

### 2.4 前端获取枚举定义

**API接口**：`GET /api/v1/dict/enums`

**响应示例**：
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "order_status": {
            "0": "待审核",
            "1": "已同意",
            "3": "待服务",
            "4": "已完成",
            "10": "已拒绝",
            "11": "已取消",
            "13": "已关闭"
        },
        "payment_status": {
            "0": "未付款",
            "1": "已付款",
            "2": "部分退款",
            "3": "已退款"
        },
        "refund_status": {
            "0": "无退款",
            "1": "退款申请中",
            "2": "退款已同意",
            "3": "退款已拒绝",
            "4": "退款已完成"
        }
    }
}
```

---

## 三、状态机代码化

### 3.1 设计原则

**原则1：状态流转必须通过状态机**
- 禁止直接UPDATE状态字段
- 所有状态变更必须调用状态机服务
- 状态机自动校验前置条件、权限、状态组合

**原则2：状态机定义来自文档**
- 状态机定义来自《11-状态机定义文档.md》
- 状态迁移规则通过代码定义
- 状态组合规则通过代码定义

**原则3：自动校验和异常处理**
- 状态机自动校验非法操作
- 状态机自动生成异常说明
- 状态机自动限制权限

### 3.2 已实现的状态机

**订单状态机**：
- `app/service/core/OrderStateMachine.php`
- 支持业务主状态、支付状态、退款状态的独立流转
- 自动校验状态组合合法性
- 自动记录状态日志

### 3.3 使用示例

```php
// ✅ 正确：通过状态机变更状态
use app\service\core\OrderStateMachine;

$stateMachine = new OrderStateMachine();
$stateMachine->transition(
    $orderId,
    OrderStatus::CONFIRMED,
    'provider',
    $providerId,
    '同意订单'
);

// ❌ 错误：直接UPDATE状态
$order->order_status = OrderStatus::CONFIRMED;
$order->save();
```

---

## 四、字段字典校验自动化

### 4.1 设计原则

**原则1：字段字典自动生成验证规则**
- 字段字典（《08-数据字段字典.md》）自动生成验证规则
- 验证规则包含：必填、类型、范围、格式等
- 验证规则在请求参数校验时自动应用

**原则2：字段字典自动生成API文档**
- 字段字典自动生成API接口文档
- API文档包含字段说明、枚举值、验证规则
- API文档与字段字典保持一致

**原则3：字段字典自动生成前端类型定义**
- 字段字典自动生成TypeScript类型定义
- 前端类型定义包含字段类型、枚举值、验证规则
- 前端类型定义与后端保持一致

### 4.2 实现方式

**验证规则生成**：
```php
// 根据字段字典自动生成验证规则
$rules = [
    'order_status' => [
        'required' => true,
        'type' => 'integer',
        'enum' => OrderStatus::getAll(),
        'description' => '订单业务主状态'
    ],
    'payment_status' => [
        'required' => true,
        'type' => 'integer',
        'enum' => PaymentStatus::getAll(),
        'description' => '支付状态'
    ]
];
```

**API文档生成**：
- 使用Swagger/OpenAPI规范
- 从字段字典自动生成API文档
- API文档包含字段说明、枚举值、验证规则

**前端类型定义生成**：
```typescript
// 自动生成的TypeScript类型定义
export enum OrderStatus {
    CREATED = 0,      // 待审核
    CONFIRMED = 1,    // 已同意
    SERVING = 3,      // 待服务
    FINISHED = 4,     // 已完成
    REJECTED = 10,    // 已拒绝
    CANCELLED = 11,   // 已取消
    CLOSED = 13,      // 已关闭
}

export interface Order {
    order_status: OrderStatus;
    payment_status: PaymentStatus;
    refund_status: RefundStatus;
}
```

---

## 五、实施检查清单

### 5.1 枚举代码生成检查

- [ ] 所有枚举值已通过枚举类定义
- [ ] 代码中无魔法数字
- [ ] 枚举类包含 `getAll()`、`getName()`、`isValid()` 方法
- [ ] 前端可通过API获取枚举定义

### 5.2 状态机代码化检查

- [ ] 所有状态变更通过状态机服务
- [ ] 状态机定义来自《11-状态机定义文档.md》
- [ ] 状态机自动校验前置条件、权限、状态组合
- [ ] 状态机自动记录状态日志

### 5.3 字段字典校验自动化检查

- [ ] 字段字典自动生成验证规则
- [ ] 验证规则在请求参数校验时自动应用
- [ ] 字段字典自动生成API文档
- [ ] 字段字典自动生成前端类型定义

---

## 六、后续优化方向

### 6.1 代码生成工具

**目标**：开发代码生成工具，自动从文档生成枚举类、状态机、验证规则

**工具功能**：
- 从《08-数据字段字典.md》生成枚举类
- 从《11-状态机定义文档.md》生成状态机代码
- 从字段字典生成验证规则
- 从字段字典生成API文档
- 从字段字典生成前端类型定义

### 6.2 文档与代码同步

**目标**：确保文档与代码保持一致

**实现方式**：
- 代码生成工具从文档读取定义
- 文档更新后自动重新生成代码
- 代码变更时自动更新文档（反向生成）

---

**文档版本**: v2.0.0  
**最后更新**: 2025-01-03

